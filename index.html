<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作紀錄中心 v2.5.9</title>
    
    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

    <!-- 2. 引入 React 和 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. 引入 OpenCC (繁簡轉換) -->
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
    
    <!-- 設定 Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Microsoft JhengHei', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        #root { min-height: 100vh; }
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #64748b;
            font-family: sans-serif;
            flex-direction: column;
            gap: 1rem;
        }
        .error-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #fee2e2;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #fca5a5;
            z-index: 9999;
            max-width: 90%;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-container">
            <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <div>系統載入中...</div>
        </div>
    </div>
    <div id="global-error" style="display:none;" class="error-box"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const errorDiv = document.getElementById('global-error');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `<strong>系統發生錯誤:</strong><br/>${message}`;
            console.error('Global Error:', error);
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        
        import { initializeApp, getApps, getApp, deleteApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, collection, collectionGroup, addDoc, updateDoc, deleteDoc, doc, getDoc, getDocs, setDoc, query, orderBy, onSnapshot, serverTimestamp, arrayUnion, arrayRemove 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { 
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            sendPasswordResetEmail,
            confirmPasswordReset,
            verifyPasswordResetCode
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        import { 
            CheckCircle2, Clock, AlertCircle, Calendar, Users, FileText, Settings, Plus, Save, X, Edit2, Trash2, Link as LinkIcon, ChevronRight, Database, RefreshCw, Check, ShieldAlert, Download, List, Search, ArrowRightLeft, LogIn, LogOut, UserPlus, Loader2, ExternalLink, ShieldCheck, Lock, UserCog, Image as ImageIcon, Info, User, Filter, Briefcase, LayoutDashboard, BarChart3, PieChart, Activity, Sparkles, Bot, Copy 
        } from 'https://esm.sh/lucide-react@0.294.0';

        // --- 0. System Constants ---
        const SYSTEM_CREATOR = "Show";
        const APP_VERSION = "v2.5.9"; // Updated: notification weekdays
        const ON_GOING_KEYWORDS = ["on-going", "ongoing", "進行"];
        const LOCALE_STORAGE_KEY = "jms-locale";
        const DEFAULT_LOCALE = "zh-Hant";
        const GEMINI_API_KEY = "AIzaSyAsnzwjsrisZVpCvmTiQVeK9lIZLeissoY";
        const AIVRES_EMAIL_DOMAIN = "@aivres.com";
        const NOTIFICATION_EMAIL_DOMAIN = "@aivres.com";

        // --- 1. Firebase Configuration ---
        const DEFAULT_CONFIG = {
            apiKey: "AIzaSyAGezrKXfKSwvh1Aauy-wrTr53e_WtuXVE",
            authDomain: "job-management-system-16741.firebaseapp.com",
            projectId: "job-management-system-16741",
            storageBucket: "job-management-system-16741.firebasestorage.app",
            messagingSenderId: "1042345096032",
            appId: "1:1042345096032:web:853c2d9c35c06b7dd9a405",
            measurementId: "G-FM8QW4LJ2T"
        };

        const ROOT_ADMINS = [
            "showchen@aivres.com",
        ];

        const checkIsAdmin = (user, cloudAdmins = []) => {
            if (!user || !user.email) return false;
            return ROOT_ADMINS.includes(user.email) || cloudAdmins.includes(user.email);
        };

        const checkIsEditor = (user, cloudEditors = []) => {
            if (!user || !user.email) return false;
            return cloudEditors.includes(user.email);
        };

        const formatEmailPrefix = (email) => {
            if (!email) return '使用者';
            const [prefix] = email.split('@');
            return prefix || email;
        };

        // --- Helper Functions ---
        const callGeminiAI = async (contentParts) => {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: contentParts }] })
                });
                if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'API request failed');
                }
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error;
            }
        };

        const cleanAIResponse = (text) => {
            if (!text) return "";
            return text
                .replace(/```[\s\S]*?```/g, (block) => block.replace(/```/g, '').trim())
                .replace(/!\[.*?\]\(.*?\)/g, '')               // 移除圖片標記
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')       // 移除連結格式
                .replace(/^>\s?/gm, '')                        // 移除引用
                .replace(/^#+\s+/gm, '')                       // 移除標題標記 (#, ##, ###)
                .replace(/^\s*[-*+]\s+/gm, '')                 // 移除無序清單
                .replace(/^\s*\d+\.\s+/gm, '')                 // 移除有序清單
                .replace(/^\s*[•・‧]\s+/gm, '')                 // 移除特殊符號清單
                .replace(/^\s*\|?[\s:-]+\|?\s*$/gm, '')         // 移除表格分隔線
                .replace(/\|/g, ' ')                           // 移除表格管線符號
                .replace(/^[-*_]{3,}$/gm, '')                  // 移除分隔線
                .replace(/(\*\*|__)(.*?)\1/g, '$2')             // 移除粗體標記
                .replace(/(\*|_)(.*?)\1/g, '$2')               // 移除斜體標記
                .replace(/~~(.*?)~~/g, '$1')                   // 移除刪除線
                .replace(/`/g, '')                             // 移除行內代碼標記
                .replace(/\n{3,}/g, '\n\n')
                .trim();
        };

        const isOnGoingStatus = (status) => {
            if (!status) return false;
            const normalized = status.trim().toLowerCase();
            return ON_GOING_KEYWORDS.some((keyword) => normalized.includes(keyword));
        };

        const extractEmailPrefix = (value) => {
            if (!value) return null;
            const normalized = String(value).trim();
            if (!normalized) return null;
            if (normalized.includes('@')) {
                const [prefix] = normalized.split('@');
                return prefix || null;
            }
            return normalized;
        };

        const resolveAssigneeEmail = (assignee, userEmails = []) => {
            const assigneePrefix = extractEmailPrefix(assignee);
            if (!assigneePrefix) return null;
            const registeredPrefixes = new Set(
                userEmails
                    .filter(Boolean)
                    .map((email) => email.split('@')[0])
            );
            if (!registeredPrefixes.has(assigneePrefix)) return null;
            return `${assigneePrefix}${NOTIFICATION_EMAIL_DOMAIN}`;
        };

        const formatLocalDate = (value = new Date()) => {
            const date = value instanceof Date ? value : new Date(value);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const buildNotificationPayloads = (tasks, userEmails, notifyDate = new Date()) => {
            const displayDate = formatLocalDate(notifyDate);
            const notifications = {};
            tasks.forEach((task) => {
                if (!isOnGoingStatus(task.status)) return;
                const assigneeEmail = resolveAssigneeEmail(task.assignee, userEmails);
                if (!assigneeEmail) return;
                notifications[assigneeEmail] = notifications[assigneeEmail] || [];
                notifications[assigneeEmail].push(task);
            });
            return Object.entries(notifications).map(([email, items]) => {
                const subject = `待辦更新提醒 (${displayDate})`;
                const lines = [
                    `您好，以下為 ${displayDate} 仍在處理中的待辦事項，請協助更新進度：`,
                    "",
                ];
                items.forEach((task) => {
                    const title = task.title || "未命名事項";
                    const dueDate = task.dueDate || "未設定";
                    lines.push(`- ${title}（預計完成：${dueDate}）`);
                });
                lines.push("", "此郵件為系統 On-going 通知，如有更新請至系統填寫。");
                return { to: email, subject, body: lines.join("\n") };
            });
        };

        const sendEmailJsNotification = async (config, payload) => {
            if (!config?.serviceId || !config?.templateId || !config?.publicKey) {
                throw new Error("尚未完成 EmailJS 設定");
            }
            const response = await fetch("https://api.emailjs.com/api/v1.0/email/send", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    service_id: config.serviceId,
                    template_id: config.templateId,
                    user_id: config.publicKey,
                    template_params: {
                        to_email: payload.to,
                        subject: payload.subject,
                        message: payload.body,
                        from_name: config.fromName || "Job Management System"
                    }
                })
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || "EmailJS 發送失敗");
            }
            return true;
        };

        const shouldSkipLocaleNode = (node) => {
            if (!node || !node.parentElement) return true;
            if (!node.nodeValue || !node.nodeValue.trim()) return true;
            const parent = node.parentElement;
            const tag = parent.tagName;
            if (["SCRIPT", "STYLE", "TEXTAREA", "INPUT"].includes(tag)) return true;
            if (parent.closest('[contenteditable="true"]')) return true;
            if (parent.closest('[data-locale-ignore="true"]')) return true;
            return false;
        };

        const applyLocaleToDocument = (locale, converters, originalTextMap, isUpdatingRef) => {
            if (!converters) return;
            if (isUpdatingRef.current) return;
            isUpdatingRef.current = true;
            const converter = locale === "zh-Hans" ? converters.toSimplified : converters.toTraditional;
            const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, {
                acceptNode: (node) => (shouldSkipLocaleNode(node) ? NodeFilter.FILTER_REJECT : NodeFilter.FILTER_ACCEPT)
            });
            let currentNode = walker.nextNode();
            while (currentNode) {
                const text = currentNode.nodeValue;
                if (locale === "zh-Hans") {
                    if (!originalTextMap.has(currentNode)) {
                        originalTextMap.set(currentNode, text);
                    }
                    currentNode.nodeValue = converter(text);
                } else {
                    const original = originalTextMap.get(currentNode);
                    currentNode.nodeValue = original || converter(text);
                }
                currentNode = walker.nextNode();
            }
            isUpdatingRef.current = false;
        };

        const copyToClipboard = (text) => {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).catch(err => {
                    console.error('Async: Could not copy text: ', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        };

        const fallbackCopyTextToClipboard = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textArea);
        };

        const extractContentForAI = (htmlContent) => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const text = tempDiv.textContent || tempDiv.innerText || "";
            const images = [];
            const imgTags = tempDiv.getElementsByTagName('img');
            for (let i = 0; i < imgTags.length; i++) {
                const src = imgTags[i].src;
                if (src.startsWith('data:image/')) {
                    const parts = src.split(',');
                    if (parts.length === 2) {
                        const mimeMatch = parts[0].match(/:(.*?);/);
                        if (mimeMatch) {
                            images.push({ inlineData: { mimeType: mimeMatch[1], data: parts[1] } });
                        }
                    }
                }
            }
            return { text, images };
        };

        const exportToCSV = (data, filename, headers) => {
            if (!data || !data.length) return;
            const bom = '\uFEFF';
            const csvContent = [
                headers.map(h => h.label).join(','),
                ...data.map(row => 
                headers.map(h => {
                    let val = row[h.key] || '';
                    if (h.key === 'content' && typeof val === 'string') val = val.replace(/<[^>]+>/g, '');
                    if (typeof val === 'string' && (val.includes(',') || val.includes('\n'))) val = `"${val.replace(/"/g, '""')}"`;
                    return val;
                }).join(',')
                )
            ].join('\n');
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const MAX_WIDTH = 800;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        };

        // --- 2. Base Components (Defined First) ---

        const Modal = ({ isOpen, title, content, onConfirm, onCancel, confirmText = '確認', cancelText = '取消', type = 'confirm', children, testId }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200" data-testid={testId}>
                <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden transform scale-100 transition-all flex flex-col max-h-[90vh]">
                    <div className="p-6 flex-shrink-0">
                    <div className="flex items-center gap-3 mb-3">
                        {type === 'danger' && <div className="p-2 bg-red-100 rounded-full text-red-600"><AlertCircle size={24} /></div>}
                        {type === 'confirm' && <div className="p-2 bg-blue-100 rounded-full text-blue-600"><Info size={24} /></div>}
                        {type === 'ai' && <div className="p-2 bg-purple-100 rounded-full text-purple-600"><Bot size={24} /></div>}
                        <h3 className={`text-lg font-bold ${type === 'danger' ? 'text-red-700' : 'text-slate-800'}`}>{title}</h3>
                    </div>
                    {content && <p className="text-slate-600 text-sm leading-relaxed ml-1 whitespace-pre-wrap">{content}</p>}
                    {children}
                    </div>
                    <div className="bg-slate-50 px-6 py-4 flex justify-end gap-3 border-t border-slate-100 flex-shrink-0">
                    {onCancel && <button onClick={onCancel} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition-colors">{cancelText}</button>}
                    <button onClick={onConfirm} className={`px-4 py-2 text-sm font-medium text-white rounded-lg shadow-sm transition-colors ${type === 'danger' ? 'bg-red-600 hover:bg-red-700' : type === 'ai' ? 'bg-purple-600 hover:bg-purple-700' : 'bg-blue-600 hover:bg-blue-700'}`}>{confirmText}</button>
                    </div>
                </div>
                </div>
            );
        };

        // 新增: CopyButton Component - 提供視覺回饋
        const CopyButton = ({ text }) => {
            const [copied, setCopied] = useState(false);
            const handleCopy = () => {
                copyToClipboard(text);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };
            return (
                <button 
                    onClick={handleCopy}
                    className={`mt-3 flex items-center gap-2 text-sm font-medium transition-colors ${copied ? 'text-green-600' : 'text-purple-600 hover:underline'}`}
                >
                    {copied ? <Check size={16} /> : <Copy size={16} />} 
                    {copied ? '已複製成功！' : '複製報告內容'}
                </button>
            );
        };

        const NavButton = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${active ? 'bg-blue-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-800 hover:text-white'}`}>{icon}<span className="font-medium">{label}</span></button>
        );

        const ContentEditor = ({ value, onChange }) => {
            const editableRef = useRef(null);
            useEffect(() => {
                if (editableRef.current && editableRef.current.innerHTML !== value) {
                    editableRef.current.innerHTML = value || '';
                }
            }, [value]);
            const handlePaste = async (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = items[i].getAsFile();
                        const base64 = await compressImage(file);
                        if (base64.length > 800 * 1024) { alert("圖片過大"); return; }
                        document.execCommand('insertImage', false, base64);
                    }
                }
            };
            const handleInput = (e) => onChange(e.currentTarget.innerHTML);
            return (
                <div className="w-full p-3 border border-slate-300 rounded min-h-[150px] max-h-[400px] overflow-y-auto focus:outline-none focus:ring-2 focus:ring-emerald-500 prose prose-sm max-w-none bg-slate-50" contentEditable ref={editableRef} onInput={handleInput} onPaste={handlePaste} data-placeholder="請輸入會議內容，可直接貼上圖片..." />
            );
        };

        // --- 3. Sub-Components (Tasks & Meetings) ---

        const TaskForm = ({ initialData, onSave, onCancel, taskSources, taskStatuses, assigneeOptions }) => {
            const [formData, setFormData] = useState({
                title: '', assignee: '', status: 'Pending', source: '', assignedDate: new Date().toISOString().split('T')[0], dueDate: '', delayReason: '', progress: '', ...initialData
            });
            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-blue-100 mb-6">
                <h3 className="font-bold text-lg mb-4 text-slate-700">{initialData ? '編輯事項' : '新增事項'}</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="col-span-2 md:col-span-1"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">事項內容 <span className="text-red-500">*</span></label><input name="title" value={formData.title} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div className="col-span-2 md:col-span-1">
                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">負責人 <span className="text-red-500">*</span></label>
                        <input
                            name="assignee"
                            value={formData.assignee}
                            onChange={handleChange}
                            className="w-full p-2 border rounded"
                            list="assignee-options"
                            data-testid="assignee-input"
                            required
                        />
                        <datalist id="assignee-options">
                            {(assigneeOptions || []).map((assignee) => (
                                <option key={assignee} value={assignee} />
                            ))}
                        </datalist>
                    </div>
                    <div className="col-span-2 md:col-span-1"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">來源 <span className="text-red-500">*</span></label><select name="source" value={formData.source} onChange={handleChange} className="w-full p-2 border rounded" required><option value="" disabled>請選擇來源</option>{taskSources.map((s, i) => <option key={i} value={s}>{s}</option>)}</select></div>
                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">狀態 <span className="text-red-500">*</span></label><select name="status" value={formData.status} onChange={handleChange} className="w-full p-2 border rounded" required><option value="" disabled>請選擇狀態</option>{taskStatuses.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">交辦日期 <span className="text-red-500">*</span></label><input type="date" name="assignedDate" value={formData.assignedDate} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">預計完成 <span className="text-red-500">*</span></label><input type="date" name="dueDate" value={formData.dueDate} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div className="col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">進展更新 <span className="text-red-500">*</span></label><textarea name="progress" value={formData.progress} onChange={handleChange} rows="2" className="w-full p-2 border rounded" required /></div>
                    <div className="col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase mb-1 text-slate-400">延遲原因 (選填)</label><input name="delayReason" value={formData.delayReason} onChange={handleChange} className="w-full p-2 border border-slate-200 bg-slate-50 rounded" placeholder="非必填" /></div>
                </div>
                <div className="flex justify-end gap-3 mt-6"><button onClick={onCancel} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">取消</button><button onClick={() => onSave(formData)} className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2"><Save size={18} /> 儲存</button></div>
                </div>
            );
        };

        const TaskRow = ({ task, onEdit, onDelete }) => {
            const getStatusColor = (status) => {
                const s = status.toLowerCase();
                if (s.includes('done') || s.includes('complete') || s.includes('完成')) return 'bg-green-100 text-green-700 border-green-200';
                if (s.includes('on-going') || s.includes('process') || s.includes('進行')) return 'bg-blue-100 text-blue-700 border-blue-200';
                if (s.includes('pending') || s.includes('wait') || s.includes('待')) return 'bg-yellow-100 text-yellow-700 border-yellow-200';
                return 'bg-gray-100 text-gray-700 border-gray-200';
            };
            return (
                <tr className="hover:bg-slate-50 transition-colors">
                <td className="px-6 py-4 whitespace-nowrap"><span className={`px-2 py-1 rounded-full text-xs font-bold border ${getStatusColor(task.status)}`}>{task.status}</span></td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{task.source || '-'}</td>
                <td className="px-6 py-4">
                    <div className="font-medium text-slate-800 max-w-xs truncate" title={task.title}>{task.title}</div>
                    {task.createdByEmail && <div className="text-[10px] text-slate-400 mt-1 flex items-center gap-1"><User size={10} /> {formatEmailPrefix(task.createdByEmail)}</div>}
                </td>
                <td className="px-6 py-4 whitespace-nowrap">{task.assignee || '-'}</td>
                <td className="px-6 py-4 whitespace-nowrap">{task.assignedDate}</td>
                <td className="px-6 py-4 whitespace-nowrap"><span className={task.dueDate && new Date(task.dueDate) < new Date() && !task.status.toLowerCase().includes('done') ? 'text-red-600 font-bold' : ''}>{task.dueDate || '-'}</span></td>
                <td className="px-6 py-4 max-w-xs"><div className="flex flex-col gap-1">{task.progress && <div className="text-xs text-slate-600 truncate" title={task.progress}>{task.progress}</div>}{task.delayReason && (<div className="flex items-center gap-1 text-xs text-red-500 truncate" title={task.delayReason}><AlertCircle size={12} /> {task.delayReason}</div>)}</div></td>
                <td className="px-6 py-4 text-right whitespace-nowrap"><div className="flex justify-end gap-2"><button onClick={onEdit} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded transition"><Edit2 size={16} /></button><button onClick={onDelete} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition"><Trash2 size={16} /></button></div></td>
                </tr>
            );
        };

        const MeetingForm = ({ initialData, onSave, onCancel, categories }) => {
            const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], host: '', attendees: '', topic: '', content: '', category: categories[0] || '', ...initialData });
            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleContentChange = (newContent) => setFormData(prev => ({ ...prev, content: newContent }));
            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-emerald-100 mb-6">
                <h3 className="font-bold text-lg mb-4 text-slate-700">{initialData ? '編輯會議記錄' : '新增會議記錄'}</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="col-span-2 md:col-span-1"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">主題 <span className="text-red-500">*</span></label><input name="topic" value={formData.topic} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div className="col-span-2 md:col-span-1"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">分類 <span className="text-red-500">*</span></label><select name="category" value={formData.category} onChange={handleChange} className="w-full p-2 border rounded" required><option value="" disabled>請選擇分類</option>{categories.map((cat, i) => <option key={i} value={cat}>{cat}</option>)}</select></div>
                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">日期 <span className="text-red-500">*</span></label><input type="date" name="date" value={formData.date} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">主持人 <span className="text-red-500">*</span></label><input name="host" value={formData.host} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div className="col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">參會人員 <span className="text-red-500">*</span></label><input name="attendees" value={formData.attendees} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div className="col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase mb-1 flex items-center justify-between"><span>內容 (支援圖片貼上) <span className="text-red-500">*</span></span><span className="text-[10px] font-normal text-slate-400 flex items-center gap-1"><ImageIcon size={10}/> 貼上截圖會自動壓縮</span></label><ContentEditor value={formData.content} onChange={handleContentChange} /></div>
                </div>
                <div className="flex justify-end gap-3 mt-6"><button onClick={onCancel} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">取消</button><button onClick={() => onSave(formData)} className="px-6 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 flex items-center gap-2"><Save size={18} /> 儲存</button></div>
                </div>
            );
        };

        const MeetingRow = ({ meeting, onEdit, onDelete }) => {
            const [expanded, setExpanded] = useState(false);
            return (
                <div className="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden group">
                <div className="p-4 flex items-center justify-between cursor-pointer hover:bg-slate-50" onClick={() => setExpanded(!expanded)}>
                    <div className="flex items-center gap-4 flex-1">
                    <div className="flex flex-col items-center justify-center bg-emerald-50 text-emerald-700 w-16 h-16 rounded-lg border border-emerald-100 flex-shrink-0"><span className="text-xs font-bold uppercase">{new Date(meeting.date).toLocaleString('default', { month: 'short' })}</span><span className="text-xl font-bold">{new Date(meeting.date).getDate()}</span></div>
                    <div><div className="flex items-center gap-2">{meeting.category && <span className="text-xs px-2 py-0.5 bg-slate-100 text-slate-600 rounded border border-slate-200">{meeting.category}</span>}<h3 className="font-bold text-slate-800">{meeting.topic}</h3></div><p className="text-sm text-slate-500 flex gap-2 mt-1"><span>{meeting.host}</span><span>•</span><span className="line-clamp-1 max-w-[200px]">{meeting.attendees}</span></p>{meeting.createdByEmail && <div className="text-[10px] text-slate-400 mt-1 flex items-center gap-1"><User size={10} /> {formatEmailPrefix(meeting.createdByEmail)}</div>}</div>
                    </div>
                    <div className="flex items-center gap-4"><ChevronRight size={20} className={`text-slate-400 transition-transform ${expanded ? 'rotate-90' : ''}`} /></div>
                </div>
                {expanded && (
                    <div className="p-4 pt-0 border-t border-slate-100 bg-slate-50">
                    <div className="mt-4 text-sm text-slate-700 leading-relaxed bg-white p-4 rounded border border-slate-200 prose prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: meeting.content || "無詳細內容" }} />
                    <div className="mt-4 flex justify-end gap-2 border-t border-slate-200 pt-3"><button onClick={onEdit} className="px-3 py-1.5 text-sm bg-white border border-slate-300 rounded hover:bg-slate-100 text-slate-600">編輯</button><button onClick={onDelete} className="px-3 py-1.5 text-sm bg-red-50 border border-red-200 rounded hover:bg-red-100 text-red-600">刪除</button></div>
                    </div>
                )}
                </div>
            );
        };

        // --- 4. Page Components (AuthPage Defined Here) ---
        
        const AuthPage = ({ auth, error, connectionStatus }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [emailPrefix, setEmailPrefix] = useState('');
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showForgot, setShowForgot] = useState(false);
            const [resetEmail, setResetEmail] = useState('');
            const [resetMessage, setResetMessage] = useState('');
            const [resetError, setResetError] = useState('');
            const [resetCode, setResetCode] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [resetLoading, setResetLoading] = useState(false);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const code = params.get('oobCode');
                if (code) {
                    setResetCode(code);
                    setShowForgot(true);
                }
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setAuthError('');
                setLoading(true);
                try {
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        const normalizedPrefix = emailPrefix.trim();
                        if (!normalizedPrefix) {
                            setAuthError('請輸入 Email 前綴');
                            setLoading(false);
                            return;
                        }
                        if (normalizedPrefix.includes('@') || !/^[A-Za-z0-9._%+-]+$/.test(normalizedPrefix)) {
                            setAuthError('Email 前綴格式不正確');
                            setLoading(false);
                            return;
                        }
                        const registerEmail = `${normalizedPrefix}${AIVRES_EMAIL_DOMAIN}`;
                        await createUserWithEmailAndPassword(auth, registerEmail, password);
                    }
                } catch (err) {
                    console.error("Auth Error:", err);
                    let msg = err.message;
                    if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found') msg = '帳號或密碼錯誤';
                    if (err.code === 'auth/email-already-in-use') msg = '此 Email 已被註冊';
                    if (err.code === 'auth/weak-password') msg = '密碼太短 (至少6位)';
                    if (err.code === 'auth/operation-not-allowed') msg = '系統錯誤：請聯繫管理員開啟 Email 登入功能';
                    setAuthError(msg);
                }
                setLoading(false);
            };

            const handleSendResetEmail = async () => {
                if (!resetEmail) {
                    setResetError('請輸入 Email 信箱');
                    return;
                }
                setResetError('');
                setResetMessage('');
                setResetLoading(true);
                try {
                    await sendPasswordResetEmail(auth, resetEmail);
                    setResetMessage('已寄送重設密碼信件，請至信箱完成變更密碼。');
                } catch (err) {
                    console.error("Reset Email Error:", err);
                    let msg = err.message;
                    if (err.code === 'auth/user-not-found') msg = '此 Email 尚未註冊';
                    if (err.code === 'auth/invalid-email') msg = 'Email 格式不正確';
                    setResetError(msg);
                }
                setResetLoading(false);
            };

            const handleConfirmReset = async (e) => {
                e.preventDefault();
                if (!newPassword || !confirmPassword) {
                    setResetError('請輸入新密碼並確認');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    setResetError('兩次輸入的密碼不一致');
                    return;
                }
                setResetError('');
                setResetMessage('');
                setResetLoading(true);
                try {
                    await verifyPasswordResetCode(auth, resetCode);
                    await confirmPasswordReset(auth, resetCode, newPassword);
                    setResetMessage('密碼已更新，請使用新密碼登入。');
                    setResetCode('');
                    setShowForgot(false);
                    setIsLogin(true);
                    setNewPassword('');
                    setConfirmPassword('');
                } catch (err) {
                    console.error("Confirm Reset Error:", err);
                    let msg = err.message;
                    if (err.code === 'auth/expired-action-code') msg = '重設連結已過期，請重新申請';
                    if (err.code === 'auth/invalid-action-code') msg = '重設連結無效，請重新申請';
                    if (err.code === 'auth/weak-password') msg = '密碼太短 (至少6位)';
                    setResetError(msg);
                }
                setResetLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden">
                    <div className="bg-slate-900 p-8 text-center">
                    <div className="inline-flex p-3 bg-blue-600 rounded-full mb-4 shadow-lg">
                        <Database size={32} className="text-white" />
                    </div>
                    <h1 className="text-2xl font-bold text-white mb-2">工作紀錄中心</h1>
                    <p className="text-slate-400 text-sm">請登入以存取您的工作資料</p>
                    <p className="text-xs text-slate-500 mt-2" data-testid="firebase-status-auth">Firebase 連線狀態：{connectionStatus}</p>
                    </div>
                    <div className="p-8">
                    {error && <div className="mb-4 p-3 bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg flex gap-2"><AlertCircle size={16} className="mt-0.5 flex-shrink-0" />{error}</div>}
                    {!showForgot && (
                        <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Email 信箱</label>
                            {isLogin ? (
                                <input
                                    type="email"
                                    required
                                    className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    data-testid="login-email"
                                />
                            ) : (
                                <div className="flex items-center rounded-lg border border-slate-300 overflow-hidden focus-within:ring-2 focus-within:ring-blue-500 transition">
                                    <input
                                        type="text"
                                        required
                                        className="w-full p-3 outline-none"
                                        placeholder="輸入 Email 前綴"
                                        value={emailPrefix}
                                        onChange={(e) => setEmailPrefix(e.target.value)}
                                    />
                                    <span className="px-3 text-slate-500 bg-slate-50 border-l border-slate-200">{AIVRES_EMAIL_DOMAIN}</span>
                                </div>
                            )}
                            {!isLogin && <p className="mt-2 text-xs text-slate-500">系統會自動補上公司信箱網域。</p>}
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">密碼</label>
                            <input
                                type="password"
                                required
                                className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                data-testid="login-password"
                            />
                        </div>
                        {authError && <div className="text-red-500 text-sm flex items-center gap-1"><AlertCircle size={14} /> {authError}</div>}
                        <button
                            type="submit"
                            disabled={loading}
                            className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2 disabled:opacity-50"
                            data-testid="login-submit"
                        >
                            {loading && <Loader2 size={18} className="animate-spin" />}{isLogin ? '登入系統' : '註冊帳號'}
                        </button>
                        {isLogin && <button type="button" onClick={() => { setShowForgot(true); setAuthError(''); setResetMessage(''); setResetError(''); }} className="w-full text-sm text-blue-600 hover:underline">忘記密碼？</button>}
                        </form>
                    )}
                    {showForgot && (
                        <form onSubmit={resetCode ? handleConfirmReset : (e) => { e.preventDefault(); handleSendResetEmail(); }} className="space-y-4">
                        {!resetCode && (
                            <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">重設信箱</label>
                            <input type="email" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" value={resetEmail} onChange={(e) => setResetEmail(e.target.value)} />
                            <p className="mt-2 text-xs text-slate-500">系統將寄出重設密碼信件。</p>
                            </div>
                        )}
                        {resetCode && (
                            <>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">新密碼</label>
                                <input type="password" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">確認新密碼</label>
                                <input type="password" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} />
                            </div>
                            </>
                        )}
                        {resetMessage && <div className="text-emerald-600 text-sm flex items-center gap-1"><CheckCircle2 size={14} /> {resetMessage}</div>}
                        {resetError && <div className="text-red-500 text-sm flex items-center gap-1"><AlertCircle size={14} /> {resetError}</div>}
                        <button type="submit" disabled={resetLoading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2 disabled:opacity-50">{resetLoading && <Loader2 size={18} className="animate-spin" />}{resetCode ? '更新密碼' : '寄送重設信件'}</button>
                        <button type="button" onClick={() => { setShowForgot(false); setResetMessage(''); setResetError(''); setResetCode(''); }} className="w-full text-sm text-slate-500 hover:underline">返回登入</button>
                        </form>
                    )}
                    <div className="mt-6 text-center text-sm text-slate-500">
                        {isLogin ? '還沒有帳號？' : '已經有帳號了？'}
                        <button
                            onClick={() => {
                                setIsLogin(!isLogin);
                                setAuthError('');
                                setEmail('');
                                setEmailPrefix('');
                            }}
                            className="ml-2 text-blue-600 font-bold hover:underline"
                        >
                            {isLogin ? '立即註冊' : '返回登入'}
                        </button>
                    </div>
                    </div>
                </div>
                </div>
            );
        };

        const Dashboard = ({ db, user, canAccessAll, isAdmin }) => {
            const [taskStats, setTaskStats] = useState({ total: 0, byStatus: {}, bySource: {}, byAssignee: {}, byAssigneeStatus: {}, statusOrder: [] });
            const [meetingStats, setMeetingStats] = useState({ total: 0, byCategory: {} });

            useEffect(() => {
                if (!db || !user) return;
                const qTasks = canAccessAll 
                    ? query(collectionGroup(db, 'tasks')) 
                    : query(collection(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'tasks'));
                const unsubTasks = onSnapshot(qTasks, (snapshot) => {
                    let t = 0; let sources = {}; let statuses = {}; let assignees = {}; let assigneeStatuses = {};
                    snapshot.forEach(doc => {
                        const data = doc.data(); t++;
                        const status = data.status || '未定義'; statuses[status] = (statuses[status] || 0) + 1;
                        const src = data.source || '未分類'; sources[src] = (sources[src] || 0) + 1;
                        const owner = data.assignee || data.createdByEmail || '未指定'; assignees[owner] = (assignees[owner] || 0) + 1;
                        if (!assigneeStatuses[owner]) { assigneeStatuses[owner] = {}; }
                        assigneeStatuses[owner][status] = (assigneeStatuses[owner][status] || 0) + 1;
                    });
                    const statusOrder = Object.entries(statuses).sort((a, b) => b[1] - a[1]).map(([status]) => status);
                    setTaskStats({ total: t, byStatus: statuses, bySource: sources, byAssignee: assignees, byAssigneeStatus: assigneeStatuses, statusOrder });
                });
                const qMeetings = canAccessAll
                    ? query(collectionGroup(db, 'meetings'))
                    : query(collection(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'meetings'));
                const unsubMeetings = onSnapshot(qMeetings, (snapshot) => {
                    let t = 0; let cats = {};
                    snapshot.forEach(doc => {
                        const data = doc.data(); t++;
                        const c = data.category || '未分類'; cats[c] = (cats[c] || 0) + 1;
                    });
                    setMeetingStats({ total: t, byCategory: cats });
                });
                return () => { unsubTasks(); unsubMeetings(); };
            }, [db, user, canAccessAll]);

            return (
                <div className="space-y-6 animate-in fade-in">
                    <div className="flex items-center gap-2"><h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><LayoutDashboard className="text-blue-600"/> 數據看板</h2>{canAccessAll && <span className={`text-xs px-2 py-1 rounded-full font-bold ${isAdmin ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}`}>{isAdmin ? 'Admin View (All Data)' : 'Editor View (All Data)'}</span>}</div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><div className="text-slate-500 text-sm font-bold uppercase mb-2">總待辦事項</div><div className="text-4xl font-bold text-slate-800">{taskStats.total}</div></div>
                        {Object.entries(taskStats.byStatus).slice(0, 3).map(([status, count], i) => {
                            const colors = ['bg-yellow-50 border-yellow-200 text-yellow-800', 'bg-blue-50 border-blue-200 text-blue-800', 'bg-green-50 border-green-200 text-green-800'];
                            return (<div key={status} className={`p-6 rounded-xl shadow-sm border ${colors[i % colors.length]}`}><div className="text-sm font-bold uppercase mb-2 opacity-80">{status}</div><div className="text-4xl font-bold">{count}</div></div>);
                        })}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><BarChart3 size={20}/> 待辦事項來源分析</h3>
                            <div className="space-y-3">{Object.keys(taskStats.bySource).length === 0 ? <p className="text-slate-400 text-sm">暫無資料</p> : Object.entries(taskStats.bySource).map(([src, count]) => (<div key={src}><div className="flex justify-between text-sm mb-1"><span className="text-slate-600">{src}</span><span className="font-bold text-slate-800">{count}</span></div><div className="w-full bg-slate-100 rounded-full h-2"><div className="bg-blue-500 h-2 rounded-full" style={{ width: `${(count / taskStats.total) * 100}%` }}></div></div></div>))}</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><User size={20}/> 負責人待辦統計</h3>
                            <div className="space-y-3">
                                {Object.keys(taskStats.byAssignee).length === 0 ? (
                                    <p className="text-slate-400 text-sm">暫無資料</p>
                                ) : (
                                    Object.entries(taskStats.byAssignee)
                                        .sort((a, b) => b[1] - a[1])
                                        .map(([name, count]) => {
                                            const assigneeStatuses = taskStats.byAssigneeStatus[name] || {};
                                            const statusList = taskStats.statusOrder.length ? taskStats.statusOrder : Object.keys(assigneeStatuses);
                                            return (
                                                <div key={name} className="text-sm p-3 rounded-lg border border-slate-100 hover:bg-slate-50">
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-slate-700 font-medium truncate">{name}</span>
                                                        <span className="font-mono font-bold text-slate-700">{count}</span>
                                                    </div>
                                                    <div className="mt-2 flex flex-wrap gap-2">
                                                        {statusList.filter((status) => assigneeStatuses[status]).map((status) => (
                                                            <span key={status} className="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">
                                                                {status} {assigneeStatuses[status]}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })
                                )}
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><PieChart size={20}/> 會議類型統計</h3>
                            <div className="flex items-center justify-between mb-6"><div><div className="text-3xl font-bold text-slate-800">{meetingStats.total}</div><div className="text-xs text-slate-500">總會議場次</div></div><div className="p-3 bg-emerald-100 rounded-full text-emerald-600"><Users size={24}/></div></div>
                            <div className="space-y-2">{Object.keys(meetingStats.byCategory).length === 0 ? <p className="text-slate-400 text-sm">暫無資料</p> : Object.entries(meetingStats.byCategory).map(([cat, count]) => (<div key={cat} className="flex justify-between items-center text-sm p-2 hover:bg-slate-50 rounded border border-transparent hover:border-slate-100"><span className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-emerald-500"></div>{cat}</span><span className="font-mono font-bold text-slate-700">{count}</span></div>))}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const TaskManager = ({ db, user, canAccessAll, isAdmin, testConfig }) => {
            const [tasks, setTasks] = useState([]);
            const [filteredTasks, setFilteredTasks] = useState([]);
            const [isEditing, setIsEditing] = useState(false);
            const [currentTask, setCurrentTask] = useState(null);
            const [modalConfig, setModalConfig] = useState({ isOpen: false });
            const [taskSources, setTaskSources] = useState(['Email', 'Meeting', 'Chat', 'Other']);
            const [taskStatuses, setTaskStatuses] = useState(['Pending', 'On-going', 'Done']);
            const [assigneeOptions, setAssigneeOptions] = useState([]);
            const isRootAdmin = ROOT_ADMINS.includes(user?.email);
            const [aiLoading, setAiLoading] = useState(false);
            const [aiReport, setAiReport] = useState('');
            const [filterStatus, setFilterStatus] = useState('All');
            const [searchQuery, setSearchQuery] = useState('');
            
            useEffect(() => {
                if (!db || !user) return;
                const q = canAccessAll 
                    ? query(collectionGroup(db, 'tasks'))
                    : query(collection(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'tasks'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, path: doc.ref.path, ...doc.data() }));
                data.sort((a, b) => { const ta = a.createdAt?.seconds || 0; const tb = b.createdAt?.seconds || 0; return tb - ta; });
                setTasks(data);
                }, (error) => console.error("Error tasks:", error));
                return () => unsubscribe();
            }, [db, user, canAccessAll]);

            useEffect(() => {
                if (!db) return;
                const settingsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'options');
                const unsubscribe = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) { const data = docSnap.data(); if (data.taskSources) setTaskSources(data.taskSources); if (data.taskStatuses) setTaskStatuses(data.taskStatuses); }
                });
                return () => unsubscribe();
            }, [db]);

            useEffect(() => {
                if (testConfig?.enabled) {
                    const params = new URLSearchParams(window.location.search);
                    const rawAssignees = params.get('testAssignees') || '';
                    const parsed = rawAssignees
                        .split(',')
                        .map((item) => item.trim())
                        .filter(Boolean);
                    const uniqueAssignees = Array.from(new Set(parsed)).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
                    setAssigneeOptions(uniqueAssignees);
                    return;
                }
                if (!db) return;
                const usersRef = collection(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'users');
                const q = query(usersRef, orderBy('lastSeen', 'desc'));
                const unsubscribe = onSnapshot(
                    q,
                    (snapshot) => {
                        const options = snapshot.docs
                            .map((docSnap) => docSnap.data()?.email)
                            .filter(Boolean)
                            .map((email) => formatEmailPrefix(email));
                        const uniqueOptions = Array.from(new Set(options)).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
                        setAssigneeOptions(uniqueOptions);
                    },
                    (error) => console.error("Error assignees:", error)
                );
                return () => unsubscribe();
            }, [db, testConfig?.enabled]);

            useEffect(() => {
                let res = tasks;
                if (filterStatus !== 'All') { res = res.filter(t => t.status === filterStatus); }
                if (searchQuery.trim()) { const lowerQ = searchQuery.toLowerCase(); res = res.filter(t => t.title.toLowerCase().includes(lowerQ) || (t.assignee && t.assignee.toLowerCase().includes(lowerQ)) || (t.createdByEmail && t.createdByEmail.toLowerCase().includes(lowerQ))); }
                setFilteredTasks(res);
            }, [tasks, filterStatus, searchQuery]);

            const handleGenerateReport = async () => {
                if (!filteredTasks.length) { setModalConfig({ isOpen: true, type: 'confirm', title: '無資料', content: "目前列表為空。", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "好", onCancel: null }); return; }
                setAiLoading(true);
                setModalConfig({ isOpen: true, type: 'ai', title: 'AI 正在思考中...', content: '正在撰寫報告...', onConfirm: null, confirmText: "", onCancel: null });
                const taskData = filteredTasks.map((t, index) => {
                    const assignee = t.assignee || t.createdByEmail || 'Unknown';
                    const dueDate = t.dueDate || '未提供';
                    const status = t.status || '未提供';
                    const progress = t.progress || '未提供';
                    return `項目${index + 1}：事項=${t.title}；負責人=${assignee}；截止日=${dueDate}；狀態=${status}；進度=${progress}`;
                }).join('\n');
                const prompt = [
                    "### 角色",
                    "你是一位結果導向的「資深專案經理 (Senior Project Manager)」，擅長將零散的工作日誌、聊天記錄或郵件內容，轉化為高含金量的「管理層彙報摘要」。",
                    "",
                    "### 任務",
                    "請根據提供的 [工作日誌/對話記錄/零散筆記]，整理出一份最新的工作進展報告。你的目標是展現產出與價值，而非僅僅列出做了什麼動作。",
                    "",
                    "### 情境",
                    "- 閱讀對象為部門主管或客戶，時間寶貴，需要一眼看到重點。",
                    "- 原始輸入可能包含執行細節（如：修復了某行代碼），你需要將其轉化為業務語言（如：提升了系統穩定性）。",
                    "",
                    "### 限制條件",
                    "- **輸出格式**：Markdown 條列式。",
                    "- **語氣風格**：自信、精簡、客觀 (Executive Summary Style)。",
                    "- **核心原則**：",
                    "  1. **量化成果**：如果有數字（時間、數量、百分比），務必強調。",
                    "  2. **區分輕重**：將「已完成的重要成果」置頂，瑣碎事務概括帶過。",
                    "  3. **強調阻礙**：若有卡關之處，必須明確指出需要什麼資源或協助。",
                    "",
                    "### 輸出範本架構",
                    "# [專案/部門名稱] 工作進度彙報",
                    "",
                    "**📅 報告週期**：[日期範圍]",
                    "**🚦 整體狀態**：[正常(綠燈) / 有風險(黃燈) / 嚴重延遲(紅燈)]",
                    "",
                    "## 1. 核心成果 (Key Achievements)",
                    "> 說明本週期內「完成」的最重要事項，強調帶來的價值。",
                    "- ✅ [成果 1]：[具體說明，例如：完成首頁改版，載入速度提升 20%]",
                    "- ✅ [成果 2]：...",
                    "",
                    "## 2. 進行中工作 (Work in Progress)",
                    "> 說明目前正在處理的大型任務及其預計完成時間。",
                    "- 🔄 [任務名稱]：目前進度 [XX]%，預計 [日期] 完成。",
                    "",
                    "## 3. 風險與阻礙 (Blockers & Risks)",
                    "> **(重要)** 需要主管關注或協助的地方。",
                    "- ⚠️ [阻礙描述]：[影響範圍] -> [建議解決方案/需要的協助]",
                    "",
                    "## 4. 下階段計劃 (Next Steps)",
                    "- [ ] [計劃 1]",
                    "- [ ] [計劃 2]",
                    "",
                    "---",
                    "",
                    "### 原始工作內容",
                    "請根據以下內容進行整理：",
                    "",
                    taskData
                ].join('\n');
                try {
                    const resultRaw = await callGeminiAI([{ text: prompt }]);
                    const result = cleanAIResponse(resultRaw);
                    setAiReport(result);
                    setModalConfig({ 
                        isOpen: true, type: 'ai', title: 'AI 智能進度總結', content: null, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null,
                        children: (<div className="mt-4"><div className="bg-slate-50 p-4 rounded-lg border border-slate-200 text-sm whitespace-pre-wrap max-h-[60vh] overflow-y-auto">{result}</div><CopyButton text={result} /></div>)
                    });
                } catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: '生成失敗', content: e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); }
                setAiLoading(false);
            };

            const handleSave = async (formData) => {
                if (!formData.title?.trim() || !formData.assignee?.trim() || !formData.source || !formData.status || !formData.assignedDate || !formData.dueDate || !formData.progress?.trim()) {
                    setModalConfig({ isOpen: true, type: 'danger', title: '驗證錯誤', content: "請填寫所有必填欄位", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "好", onCancel: null });
                    return;
                }
                try {
                if (formData.id && formData.path) {
                    const docRef = doc(db, formData.path);
                    await updateDoc(docRef, { ...formData, updatedAt: serverTimestamp() });
                } else {
                    const collectionRef = collection(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'tasks');
                    await addDoc(collectionRef, { ...formData, updatedAt: serverTimestamp(), createdAt: serverTimestamp(), createdByEmail: user.email });
                }
                setIsEditing(false); setCurrentTask(null);
                } catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); }
            };

            const confirmDelete = (task) => {
                setModalConfig({ isOpen: true, type: 'danger', title: '確認刪除', content: '確定要刪除此項目？', onConfirm: () => executeDelete(task), onCancel: () => setModalConfig({ isOpen: false }) });
            };

            const executeDelete = async (task) => {
                setModalConfig({ isOpen: false });
                try {
                if (task.path) { await deleteDoc(doc(db, task.path)); } else { await deleteDoc(doc(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'tasks', task.id)); }
                } catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); }
            };

            const handleExport = () => { 
                const headers = [{key:'status',label:'狀態'},{key:'title',label:'事項'},{key:'assignee',label:'負責人'},{key:'createdByEmail',label:'建立者'}]; 
                exportToCSV(filteredTasks, 'WorkTasks', headers); 
            };

            return (
                <div className="space-y-6 animate-in fade-in">
                <Modal {...modalConfig} />
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div className="flex items-center gap-2"><h2 className="text-2xl font-bold text-slate-800">工作待辦事項</h2>{canAccessAll && <span className={`text-xs px-2 py-1 rounded-full font-bold ${isAdmin ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}`}>{isAdmin ? 'Admin View' : 'Editor View'}</span>}</div>
                    <div className="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                        <div className="flex items-center gap-2 bg-white border border-slate-300 rounded-lg px-2 py-1.5 shadow-sm w-full sm:w-auto"><Search size={16} className="text-slate-400" /><input className="outline-none text-sm w-full sm:w-32" placeholder="搜尋..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} /></div>
                        <div className="flex items-center gap-2 bg-white border border-slate-300 rounded-lg px-2 py-1.5 shadow-sm w-full sm:w-auto"><Filter size={16} className="text-slate-400" /><select className="outline-none text-sm w-full sm:w-24 bg-transparent" value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)}><option value="All">全部狀態</option>{taskStatuses.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                        {isAdmin && <button onClick={handleGenerateReport} className="flex items-center justify-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition shadow-sm w-full sm:w-auto">{aiLoading ? <Loader2 size={18} className="animate-spin"/> : <Sparkles size={18} />} AI 總結</button>}
                        <button onClick={handleExport} className="flex items-center justify-center gap-2 bg-white text-slate-600 border border-slate-300 px-4 py-2 rounded-lg hover:bg-slate-50 transition shadow-sm w-full sm:w-auto"><Download size={18} /> 匯出</button>
                        <button onClick={() => { setCurrentTask(null); setIsEditing(true); }} className="flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow-md w-full sm:w-auto"><Plus size={18} /> 新增</button>
                    </div>
                </div>
                {isEditing && (
                    <TaskForm
                        initialData={currentTask}
                        taskSources={taskSources}
                        taskStatuses={taskStatuses}
                        assigneeOptions={assigneeOptions}
                        onSave={handleSave}
                        onCancel={() => setIsEditing(false)}
                    />
                )}
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-slate-600">
                        <thead className="bg-slate-50 text-slate-700 font-bold uppercase text-xs">
                        <tr><th className="px-6 py-3">狀態</th><th className="px-6 py-3">來源</th><th className="px-6 py-3 min-w-[200px]">事項內容 (建立者)</th><th className="px-6 py-3">負責人</th><th className="px-6 py-3">交辦日期</th><th className="px-6 py-3">預計完成</th><th className="px-6 py-3 min-w-[150px]">進度</th><th className="px-6 py-3 text-right">操作</th></tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                        {filteredTasks.map(task => (<TaskRow key={task.id} task={task} onEdit={() => { setCurrentTask(task); setIsEditing(true); }} onDelete={() => confirmDelete(task)} />))}
                        {filteredTasks.length === 0 && <tr><td colSpan="8" className="px-6 py-12 text-center text-slate-400">沒有資料</td></tr>}
                        </tbody>
                    </table>
                    </div>
                </div>
                </div>
            );
        };

        const MeetingMinutes = ({ db, user, canAccessAll, isAdmin, isRootAdmin }) => {
            const [meetings, setMeetings] = useState([]);
            const [filteredMeetings, setFilteredMeetings] = useState([]);
            const [isEditing, setIsEditing] = useState(false);
            const [currentMeeting, setCurrentMeeting] = useState(null);
            const [categories, setCategories] = useState(['內部會議', '客戶會議', '專案檢討']);
            const [modalConfig, setModalConfig] = useState({ isOpen: false });
            const [aiLoading, setAiLoading] = useState(false);
            const [filterCategory, setFilterCategory] = useState('All');
            const [searchQuery, setSearchQuery] = useState('');

            useEffect(() => {
                if (!db || !user) return;
                const q = canAccessAll
                    ? query(collectionGroup(db, 'meetings'))
                    : query(collection(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'meetings'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, path: doc.ref.path, ...doc.data() }));
                data.sort((a, b) => (new Date(b.date) - new Date(a.date)));
                setMeetings(data);
                }, (error) => console.error(error));
                return () => unsubscribe();
            }, [db, user, canAccessAll]);

            useEffect(() => {
                if (!db) return;
                const settingsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'options');
                const unsubscribe = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().meetingCategories) { setCategories(docSnap.data().meetingCategories); }
                });
                return () => unsubscribe();
            }, [db]);

            useEffect(() => {
                let res = meetings;
                if (filterCategory !== 'All') { res = res.filter(m => m.category === filterCategory); }
                if (searchQuery.trim()) { const lowerQ = searchQuery.toLowerCase(); res = res.filter(m => m.topic.toLowerCase().includes(lowerQ) || m.host.toLowerCase().includes(lowerQ) || (m.createdByEmail && m.createdByEmail.toLowerCase().includes(lowerQ))); }
                setFilteredMeetings(res);
            }, [meetings, filterCategory, searchQuery]);

            const handleGenerateMeetingReport = async () => {
                if (!filteredMeetings.length) { setModalConfig({ isOpen: true, type: 'confirm', title: '無資料', content: "目前列表為空。", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "好", onCancel: null }); return; }
                setAiLoading(true);
                setModalConfig({ isOpen: true, type: 'ai', title: 'AI 正在分析...', content: '正在閱讀記錄...', onConfirm: null, confirmText: "", onCancel: null });
                try {
                    const parts = [];
                    const meetingsToAnalyze = filteredMeetings.slice(0, 5); 
                    let promptText = [
                        "### 角色",
                        "你是一位擁有 10 年經驗的「資深高階行政秘書」，擅長資訊萃取、邏輯歸納與商務溝通。你具備將零散、口語化的會議對話轉化為條理分明、具備執行力的專業會議紀錄的能力。",
                        "",
                        "### 任務",
                        "請閱讀並分析提供的 [會議記錄/逐字稿/筆記]，產出一份結構化的會議紀要。你的目標是讓未參與會議的主管或同仁能在 3 分鐘內掌握會議重點與後續行動。",
                        "",
                        "### 情境",
                        "- 原始資料可能包含口語贅字、離題討論或不完整的句子，你需要過濾雜訊，僅保留核心價值資訊。",
                        "- 若會議中涉及多個議題，請依照議題進行分類歸納。",
                        "",
                        "### 限制條件",
                        "- **輸出格式**：Markdown 格式（請參考下方範本）。",
                        "- **語氣風格**：專業、客觀、簡練（Business Professional）。",
                        "- **語言**：繁體中文（台灣慣用語）。",
                        "- **內容處理**：",
                        "  1. 遇到模糊不清的日期或人名，請標註「[需確認]」。",
                        "  2. 待辦事項（Action Items）必須包含「負責人」與「預計完成時間」（若無提及則標註待定）。",
                        "",
                        "### 輸出範本架構",
                        "# [會議名稱] 會議紀要",
                        "",
                        "**會議時間**：[YYYY/MM/DD]",
                        "**與會人員**：[列出名單]",
                        "",
                        "## 1. 執行摘要 (Executive Summary)",
                        "> 用 3-5 句話概括本次會議的核心目的與最重要結論。",
                        "",
                        "## 2. 重點議題討論",
                        "* **議題一：[議題名稱]**",
                        "    * 討論重點：...",
                        "    * 關鍵數據/事實：...",
                        "* **議題二：[議題名稱]**",
                        "    * ...",
                        "",
                        "## 3. 關鍵決策 (Key Decisions)",
                        "* [決策 1]",
                        "* [決策 2]",
                        "",
                        "## 4. 待辦事項 (Action Items)",
                        "| 事項描述 | 負責人 | 截止日期 |",
                        "| :--- | :--- | :--- |",
                        "| [具體行動] | [姓名] | [日期] |",
                        "",
                        "---",
                        "",
                        "### 原始會議內容",
                        "請根據以下內容進行整理：",
                        ""
                    ].join('\n');
                    meetingsToAnalyze.forEach((m, index) => {
                        const { text, images } = extractContentForAI(m.content);
                        promptText += `--- 會議 ${index + 1}: ${m.date} ${m.topic} ---\n${text}\n\n`;
                        images.forEach(img => { parts.push(img); });
                    });
                    parts.unshift({ text: promptText });
                    const resultRaw = await callGeminiAI(parts);
                    const result = cleanAIResponse(resultRaw);
                    setModalConfig({ 
                        isOpen: true, type: 'ai', title: 'AI 會議智能總結', content: null, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null,
                        children: (<div className="mt-4"><div className="bg-slate-50 p-4 rounded-lg border border-slate-200 text-sm whitespace-pre-wrap max-h-[60vh] overflow-y-auto">{result}</div><CopyButton text={result} /></div>)
                    });
                } catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: '生成失敗', content: e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); }
                setAiLoading(false);
            };

            const handleSave = async (formData) => {
                if (!formData.content || formData.content.trim() === '') { setModalConfig({ isOpen: true, type: 'danger', title: '驗證錯誤', content: "內容必填", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "好", onCancel: null }); return; }
                try {
                if (formData.id && formData.path) { await updateDoc(doc(db, formData.path), { ...formData, updatedAt: serverTimestamp() }); } 
                else { const collectionRef = collection(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'meetings'); await addDoc(collectionRef, { ...formData, updatedAt: serverTimestamp(), createdAt: serverTimestamp(), createdByEmail: user.email }); }
                setIsEditing(false); setCurrentMeeting(null);
                } catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); }
            };
            const confirmDelete = (meeting) => { setModalConfig({ isOpen: true, type: 'danger', title: '確認刪除', content: '確定要刪除？', onConfirm: () => executeDelete(meeting), onCancel: () => setModalConfig({ isOpen: false }) }); };
            const executeDelete = async (meeting) => {
                setModalConfig({ isOpen: false });
                try { if (meeting.path) { await deleteDoc(doc(db, meeting.path)); } else { await deleteDoc(doc(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'meetings', meeting.id)); } } 
                catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); }
            };
            const handleExport = () => { /* ... */ };

            return (
                <div className="space-y-6 animate-in fade-in">
                <Modal {...modalConfig} />
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div className="flex items-center gap-2"><h2 className="text-2xl font-bold text-slate-800">會議記錄工具</h2>{canAccessAll && <span className={`text-xs px-2 py-1 rounded-full font-bold ${isAdmin ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}`}>{isAdmin ? 'Admin View' : 'Editor View'}</span>}</div>
                    <div className="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                        <div className="flex items-center gap-2 bg-white border border-slate-300 rounded-lg px-2 py-1.5 shadow-sm w-full sm:w-auto"><Search size={16} className="text-slate-400" /><input className="outline-none text-sm w-full sm:w-32" placeholder="搜尋..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} /></div>
                        {isAdmin && <button onClick={handleGenerateMeetingReport} className="flex items-center justify-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition shadow-sm w-full sm:w-auto">{aiLoading ? <Loader2 size={18} className="animate-spin"/> : <Sparkles size={18} />} AI 總結</button>}
                        <button onClick={() => { setCurrentMeeting(null); setIsEditing(true); }} className="flex items-center justify-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition shadow-md w-full sm:w-auto"><Plus size={18} /> 新增</button>
                    </div>
                </div>
                {isEditing ? (
                    <MeetingForm initialData={currentMeeting} categories={categories} onSave={handleSave} onCancel={() => setIsEditing(false)} />
                ) : (
                    <div className="space-y-4">
                    {filteredMeetings.map(meeting => (
                        <MeetingRow key={meeting.id} meeting={meeting} onEdit={() => { setCurrentMeeting(meeting); setIsEditing(true); }} onDelete={() => confirmDelete(meeting)} />
                    ))}
                    {filteredMeetings.length === 0 && <div className="text-center py-12 text-slate-400 bg-white rounded-xl border border-dashed border-slate-300">沒有資料</div>}
                    </div>
                )}
                </div>
            );
        };

        const SettingsPage = ({ db, user, isAdmin, cloudAdmins, cloudEditors, rootAdmins, onSaveGeminiKey, testConfig }) => {
            const [newCategory, setNewCategory] = useState('');
            const [categories, setCategories] = useState([]);
            const [newTaskSource, setNewTaskSource] = useState('');
            const [taskSources, setTaskSources] = useState([]);
            const [newTaskStatus, setNewTaskStatus] = useState('');
            const [taskStatuses, setTaskStatuses] = useState([]);
            const [newAdminEmail, setNewAdminEmail] = useState('');
            const [newEditorEmail, setNewEditorEmail] = useState('');
            const [modalConfig, setModalConfig] = useState({ isOpen: false });
            const [allUsers, setAllUsers] = useState([]);
            const [isUserListLoading, setIsUserListLoading] = useState(false);
            const [userListError, setUserListError] = useState('');
            const [emailServiceConfig, setEmailServiceConfig] = useState({
                provider: 'emailjs',
                serviceId: '',
                templateId: '',
                publicKey: '',
                fromName: ''
            });
            const [emailServiceError, setEmailServiceError] = useState('');
            const [isEmailServiceSaving, setIsEmailServiceSaving] = useState(false);
            const [isManualNotificationSending, setIsManualNotificationSending] = useState(false);
            const userTableColSpan = isAdmin ? 4 : 3;

            useEffect(() => {
                if (!db) return;
                const settingsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'options');
                const unsubscribe = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setCategories(data.meetingCategories || ['內部會議', '客戶會議', '專案檢討', '腦力激盪']);
                        setTaskSources(data.taskSources || ['Email', 'Meeting', 'Chat', 'Other']);
                        setTaskStatuses(data.taskStatuses || ['Pending', 'On-going', 'Done']);
                    } else {
                        setCategories(['內部會議', '客戶會議', '專案檢討', '腦力激盪']);
                        setTaskSources(['Email', 'Meeting', 'Chat', 'Other']);
                        setTaskStatuses(['Pending', 'On-going', 'Done']);
                    }
                });
                return () => unsubscribe();
            }, [db]);

            useEffect(() => {
                if (!db || !isAdmin) return;
                setIsUserListLoading(true);
                setUserListError('');
                const q = query(collection(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'users'), orderBy('lastSeen', 'desc'));
                const unsubscribe = onSnapshot(
                    q,
                    (snapshot) => {
                        const users = snapshot.docs.map((docSnap) => {
                            const data = docSnap.data();
                            return {
                                ...data,
                                uid: data.uid || docSnap.id,
                                email: data.email || '(未填寫)',
                                docId: docSnap.id
                            };
                        });
                        setAllUsers(users);
                        setIsUserListLoading(false);
                    },
                    (error) => {
                        console.error('User list snapshot error:', error);
                        setUserListError(`讀取失敗：${error.message}`);
                        setIsUserListLoading(false);
                    }
                );
                return () => unsubscribe();
            }, [db, isAdmin]);

            useEffect(() => {
                if (!db || !isAdmin) return;
                const emailServiceRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'emailService');
                const unsubscribe = onSnapshot(
                    emailServiceRef,
                    (docSnap) => {
                        setEmailServiceError('');
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            setEmailServiceConfig({
                                provider: data.provider || 'emailjs',
                                serviceId: data.serviceId || '',
                                templateId: data.templateId || '',
                                publicKey: data.publicKey || '',
                                fromName: data.fromName || ''
                            });
                        } else {
                            setEmailServiceConfig({
                                provider: 'emailjs',
                                serviceId: '',
                                templateId: '',
                                publicKey: '',
                                fromName: ''
                            });
                        }
                    },
                    (error) => {
                        console.error('Email service settings snapshot error:', error);
                        setEmailServiceError(`讀取失敗：${error.message}`);
                    }
                );
                return () => unsubscribe();
            }, [db, isAdmin]);

            const handleAddItem = async (field, newItem, list, setListState, setNewItemState) => {
                if (!newItem.trim()) return;
                if (list.includes(newItem.trim())) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "此選項已存在", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); return; }
                try { await setDoc(doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'options'), { [field]: arrayUnion(newItem.trim()) }, { merge: true }); setNewItemState(''); } 
                catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "更新失敗：" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); }
            };
            const confirmDeleteItem = (field, itemToDelete, list) => { setModalConfig({ isOpen: true, type: 'danger', title: '確認刪除', content: `確定要刪除「${itemToDelete}」嗎？`, onConfirm: () => executeDeleteItem(field, itemToDelete, list), onCancel: () => setModalConfig({ isOpen: false }) }); };
            const executeDeleteItem = async (field, itemToDelete, list) => {
                setModalConfig({ isOpen: false });
                const settingsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'options');
                try {
                    const snapshot = await getDoc(settingsRef);
                    let updatedList = [];
                    if (snapshot.exists()) { updatedList = (snapshot.data()[field] || []).filter(c => c !== itemToDelete); } 
                    else { updatedList = list.filter(c => c !== itemToDelete); }
                    await setDoc(settingsRef, { [field]: updatedList }, { merge: true });
                } catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "刪除失敗：" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); }
            };
            const confirmDeleteUser = (userToDelete) => {
                if (!isAdmin) return;
                const label = formatEmailPrefix(userToDelete.email);
                setModalConfig({
                    isOpen: true,
                    type: 'danger',
                    title: '刪除使用者',
                    content: `確定要刪除 ${label} 的註冊資料嗎？此操作僅會移除登入清單記錄。`,
                    onConfirm: () => executeDeleteUser(userToDelete),
                    onCancel: () => setModalConfig({ isOpen: false })
                });
            };
            const executeDeleteUser = async (userToDelete) => {
                if (!db || !userToDelete?.docId) return;
                setModalConfig({ isOpen: false });
                try {
                    await deleteDoc(doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'users', userToDelete.docId));
                    setModalConfig({
                        isOpen: true,
                        type: 'confirm',
                        title: '刪除成功',
                        content: `已刪除 ${formatEmailPrefix(userToDelete.email)} 的註冊資料。`,
                        onConfirm: () => setModalConfig({ isOpen: false }),
                        confirmText: "好",
                        onCancel: null
                    });
                } catch (e) {
                    setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "刪除失敗：" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null });
                }
            };
            const handleAddAdmin = async () => {
                if (!newAdminEmail.trim() || !newAdminEmail.includes('@')) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "Email 格式錯誤", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); return; }
                if (cloudAdmins.includes(newAdminEmail.trim()) || rootAdmins.includes(newAdminEmail.trim())) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "該使用者已經是管理員", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); return; }
                try { await setDoc(doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'admins'), { list: arrayUnion(newAdminEmail.trim()) }, { merge: true }); setNewAdminEmail(''); setModalConfig({ isOpen: true, type: 'confirm', title: '成功', content: `已將 ${newAdminEmail} 新增為管理員`, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "好", onCancel: null }); } 
                catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "操作失敗：" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); }
            };
            const confirmRemoveAdmin = (emailToRemove) => { setModalConfig({ isOpen: true, type: 'danger', title: '移除權限', content: `確定要移除 ${formatEmailPrefix(emailToRemove)} 的管理員權限？`, onConfirm: () => executeRemoveAdmin(emailToRemove), onCancel: () => setModalConfig({ isOpen: false }) }); };
            const executeRemoveAdmin = async (emailToRemove) => {
                setModalConfig({ isOpen: false });
                const adminsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'admins');
                try { const snapshot = await getDoc(adminsRef); if (snapshot.exists()) { const updatedList = (snapshot.data().list || []).filter(e => e !== emailToRemove); await setDoc(adminsRef, { list: updatedList }, { merge: true }); } } 
                catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "操作失敗：" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); }
            };

            const handleAddEditor = async () => {
                if (!newEditorEmail.trim() || !newEditorEmail.includes('@')) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "Email 格式錯誤", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); return; }
                if (cloudEditors.includes(newEditorEmail.trim())) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "該使用者已經是編輯者", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); return; }
                if (cloudAdmins.includes(newEditorEmail.trim()) || rootAdmins.includes(newEditorEmail.trim())) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "該使用者已經是管理員", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); return; }
                try { await setDoc(doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'editors'), { list: arrayUnion(newEditorEmail.trim()) }, { merge: true }); setNewEditorEmail(''); setModalConfig({ isOpen: true, type: 'confirm', title: '成功', content: `已將 ${newEditorEmail} 新增為編輯者`, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "好", onCancel: null }); } 
                catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "操作失敗：" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); }
            };
            const confirmRemoveEditor = (emailToRemove) => { setModalConfig({ isOpen: true, type: 'danger', title: '移除權限', content: `確定要移除 ${formatEmailPrefix(emailToRemove)} 的編輯者權限？`, onConfirm: () => executeRemoveEditor(emailToRemove), onCancel: () => setModalConfig({ isOpen: false }) }); };
            const executeRemoveEditor = async (emailToRemove) => {
                setModalConfig({ isOpen: false });
                const editorsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'editors');
                try { const snapshot = await getDoc(editorsRef); if (snapshot.exists()) { const updatedList = (snapshot.data().list || []).filter(e => e !== emailToRemove); await setDoc(editorsRef, { list: updatedList }, { merge: true }); } }
                catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "操作失敗：" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null }); }
            };

            const handleEmailServiceChange = (field, value) => {
                setEmailServiceConfig((prev) => ({ ...prev, [field]: value }));
            };

            const handleSaveEmailServiceSettings = async () => {
                if (!db) {
                    setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "目前無法儲存 Email 服務設定", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null });
                    return;
                }
                if (!emailServiceConfig.serviceId.trim() || !emailServiceConfig.templateId.trim() || !emailServiceConfig.publicKey.trim()) {
                    setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "請填寫 EmailJS Service ID / Template ID / Public Key", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null });
                    return;
                }
                setIsEmailServiceSaving(true);
                try {
                    await setDoc(
                        doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'emailService'),
                        {
                            provider: 'emailjs',
                            serviceId: emailServiceConfig.serviceId.trim(),
                            templateId: emailServiceConfig.templateId.trim(),
                            publicKey: emailServiceConfig.publicKey.trim(),
                            fromName: emailServiceConfig.fromName.trim(),
                            updatedAt: serverTimestamp(),
                            updatedBy: user?.email || null
                        },
                        { merge: true }
                    );
                    setModalConfig({ isOpen: true, type: 'confirm', title: '成功', content: "Email 服務設定已更新", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "好", onCancel: null });
                } catch (e) {
                    setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "更新失敗：" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null });
                } finally {
                    setIsEmailServiceSaving(false);
                }
            };

            const fetchOnGoingNotificationPayloads = async (notifyDate) => {
                const taskSnapshot = await getDocs(query(collectionGroup(db, 'tasks')));
                const tasks = taskSnapshot.docs.map((docSnap) => docSnap.data());
                const usersSnapshot = await getDocs(collection(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'users'));
                const userEmails = usersSnapshot.docs
                    .map((docSnap) => docSnap.data()?.email)
                    .filter(Boolean);
                return buildNotificationPayloads(tasks, userEmails, notifyDate);
            };


            const handleManualOnGoingNotification = async () => {
                if (!db) {
                    setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "目前無法發送通知", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null });
                    return;
                }
                if (!emailServiceConfig.serviceId.trim() || !emailServiceConfig.templateId.trim() || !emailServiceConfig.publicKey.trim()) {
                    setModalConfig({ isOpen: true, type: 'danger', title: '錯誤', content: "請先完成 EmailJS 服務設定", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "關閉", onCancel: null });
                    return;
                }
                setIsManualNotificationSending(true);
                try {
                    const notifyDate = new Date();
                    const payloads = await fetchOnGoingNotificationPayloads(notifyDate);
                    if (!payloads.length) {
                        setModalConfig({
                            isOpen: true,
                            type: 'danger',
                            title: '無通知可發送',
                            content: '目前沒有 On-going 待辦事項或負責人資料。',
                            onConfirm: () => setModalConfig({ isOpen: false }),
                            confirmText: '關閉',
                            onCancel: null
                        });
                        return;
                    }
                    const recipients = [...new Set(payloads.map((payload) => payload.to))];
                    const preview = `通知數量：${payloads.length}\n收件人：${recipients.join('、')}`;
                    setModalConfig({
                        isOpen: true,
                        type: 'confirm',
                        title: '確認發送 On-going 通知',
                        content: `將會發送目前 On-going 待辦的通知（不受每日限制）。\n${preview}`,
                        onConfirm: async () => {
                            setModalConfig({ isOpen: false });
                            setIsManualNotificationSending(true);
                            try {
                                for (const payload of payloads) {
                                    await sendEmailJsNotification(emailServiceConfig, payload);
                                }
                                setModalConfig({
                                    isOpen: true,
                                    type: 'confirm',
                                    title: '通知發送完成',
                                    content: preview,
                                    onConfirm: () => setModalConfig({ isOpen: false }),
                                    confirmText: '關閉',
                                    onCancel: null
                                });
                            } catch (error) {
                                setModalConfig({
                                    isOpen: true,
                                    type: 'danger',
                                    title: '發送失敗',
                                    content: `EmailJS 發送失敗：${error.message}`,
                                    onConfirm: () => setModalConfig({ isOpen: false }),
                                    confirmText: '關閉',
                                    onCancel: null
                                });
                            } finally {
                                setIsManualNotificationSending(false);
                            }
                        },
                        confirmText: '確認發送',
                        onCancel: () => setModalConfig({ isOpen: false })
                    });
                } catch (error) {
                    setModalConfig({
                        isOpen: true,
                        type: 'danger',
                        title: '發送失敗',
                        content: `通知準備失敗：${error.message}`,
                        onConfirm: () => setModalConfig({ isOpen: false }),
                        confirmText: '關閉',
                        onCancel: null
                    });
                } finally {
                    setIsManualNotificationSending(false);
                }
            };

            return (
                <div className="max-w-3xl mx-auto space-y-8 pb-12">
                    <Modal {...modalConfig} />
                    
                    {/* User Registry List */}
                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-200" data-testid="registered-users">
                        <div className="flex items-center gap-3 mb-6"><div className="p-3 bg-blue-100 rounded-full"><Users className="text-blue-700" size={24} /></div><div><h2 className="text-xl font-bold text-slate-800">已註冊使用者列表</h2><p className="text-sm text-slate-500">檢視所有登入過系統的帳號</p></div></div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left text-slate-600">
                                <thead className="bg-slate-50 text-slate-700 font-bold uppercase text-xs">
                                    <tr>
                                        <th className="px-4 py-3">使用者</th>
                                        <th className="px-4 py-3">User UID</th>
                                        <th className="px-4 py-3">最後上線</th>
                                        {isAdmin && <th className="px-4 py-3 text-right">操作</th>}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {userListError ? (
                                        <tr><td colSpan={userTableColSpan} className="px-4 py-4 text-center text-red-500">{userListError}</td></tr>
                                    ) : isUserListLoading ? (
                                        <tr><td colSpan={userTableColSpan} className="px-4 py-4 text-center text-slate-400">資料載入中...</td></tr>
                                    ) : allUsers.length === 0 ? (
                                        <tr><td colSpan={userTableColSpan} className="px-4 py-4 text-center text-slate-400">尚無資料</td></tr>
                                    ) : (
                                        allUsers.map((u) => {
                                            const lastSeenDate = u.lastSeen?.toDate
                                                ? u.lastSeen.toDate()
                                                : (u.lastSeen?.seconds ? new Date(u.lastSeen.seconds * 1000) : null);
                                            const isSelf = user?.email && u.email === user.email;
                                            const isRootAdmin = rootAdmins.includes(u.email);
                                            const canDelete = isAdmin && !isSelf && !isRootAdmin;
                                            return (
                                                <tr key={u.uid} className="hover:bg-slate-50">
                                                    <td className="px-4 py-3 font-medium text-slate-800">{formatEmailPrefix(u.email)}</td>
                                                    <td className="px-4 py-3 font-mono text-xs text-slate-500">{u.uid}</td>
                                                    <td className="px-4 py-3 text-xs">{lastSeenDate ? lastSeenDate.toLocaleString() : 'N/A'}</td>
                                                    {isAdmin && (
                                                        <td className="px-4 py-3 text-right">
                                                            <button
                                                                onClick={() => canDelete && confirmDeleteUser(u)}
                                                                disabled={!canDelete}
                                                                className={`p-1 rounded transition ${canDelete ? 'text-red-500 hover:text-red-700 hover:bg-red-50' : 'text-slate-300 cursor-not-allowed'}`}
                                                                title={canDelete ? '刪除使用者' : (isSelf ? '不可刪除自己' : '不可刪除系統管理員')}
                                                            >
                                                                <Trash2 size={16} />
                                                            </button>
                                                        </td>
                                                    )}
                                                </tr>
                                            );
                                        })
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Notification Settings */}
                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-200" data-testid="notification-settings">
                        <div className="flex items-center gap-3 mb-6">
                            <div className={`p-3 rounded-full ${isAdmin ? 'bg-amber-100' : 'bg-slate-100'}`}>
                                {isAdmin ? <Clock className="text-amber-700" size={24} /> : <Lock className="text-slate-500" size={24} />}
                            </div>
                            <div>
                                <h2 className="text-xl font-bold text-slate-800">郵件通知設定</h2>
                                <p className="text-sm text-slate-500">設定 EmailJS 服務並手動發送 On-going 通知</p>
                            </div>
                        </div>
                        {emailServiceError && (
                            <div className="mb-4 text-sm text-red-600">{emailServiceError}</div>
                        )}
                        <div className="flex flex-col gap-4">
                            <div className="pt-4 border-t border-slate-100 space-y-3">
                                <h3 className="text-sm font-bold text-slate-700">EmailJS 發信服務設定</h3>
                                <p className="text-xs text-slate-400">
                                    需先於 EmailJS 建立服務與範本，並提供 template params：to_email / subject / message / from_name。
                                </p>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Service ID</label>
                                        <input
                                            type="text"
                                            value={emailServiceConfig.serviceId}
                                            onChange={(e) => handleEmailServiceChange('serviceId', e.target.value)}
                                            className="w-full p-2 border rounded"
                                            data-testid="emailjs-service-id"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Template ID</label>
                                        <input
                                            type="text"
                                            value={emailServiceConfig.templateId}
                                            onChange={(e) => handleEmailServiceChange('templateId', e.target.value)}
                                            className="w-full p-2 border rounded"
                                            data-testid="emailjs-template-id"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Public Key</label>
                                        <input
                                            type="text"
                                            value={emailServiceConfig.publicKey}
                                            onChange={(e) => handleEmailServiceChange('publicKey', e.target.value)}
                                            className="w-full p-2 border rounded"
                                            data-testid="emailjs-public-key"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">寄件人名稱</label>
                                        <input
                                            type="text"
                                            value={emailServiceConfig.fromName}
                                            onChange={(e) => handleEmailServiceChange('fromName', e.target.value)}
                                            className="w-full p-2 border rounded"
                                            placeholder="Job Management System"
                                            data-testid="emailjs-from-name"
                                        />
                                    </div>
                                </div>
                                <div className="flex justify-end">
                                    <button
                                        onClick={handleSaveEmailServiceSettings}
                                        className="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                        disabled={!db || isEmailServiceSaving}
                                        data-testid="emailjs-save-button"
                                    >
                                        {isEmailServiceSaving ? '儲存中...' : '儲存 Email 服務'}
                                    </button>
                                </div>
                            </div>
                            <div className="pt-4 border-t border-slate-100" data-testid="notification-manual-trigger">
                                <h3 className="text-sm font-bold text-slate-700 mb-2">發送 On-going 通知</h3>
                                <p className="text-xs text-slate-400 mb-3">
                                    依目前 On-going 待辦與負責人資料寄送通知，不受每日限制，且不會更新每日寄送紀錄。
                                </p>
                                <div className="flex justify-end">
                                    <button
                                        onClick={handleManualOnGoingNotification}
                                        className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                        disabled={isManualNotificationSending}
                                        data-testid="notification-manual-trigger-button"
                                    >
                                        {isManualNotificationSending ? '發送中...' : '立即發送 On-going 通知'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Admin Management Panel */}
                    {isAdmin && (
                        <div className="bg-yellow-50 p-8 rounded-xl shadow-sm border border-yellow-200">
                            <div className="flex items-center gap-3 mb-6"><div className="p-3 bg-yellow-100 rounded-full"><UserCog className="text-yellow-700" size={24} /></div><div><h2 className="text-xl font-bold text-yellow-900">使用者權限管理</h2><p className="text-sm text-yellow-700">管理誰可以修改全域設定</p></div></div>
                            <div className="flex gap-2 mb-6"><input value={newAdminEmail} onChange={(e) => setNewAdminEmail(e.target.value)} placeholder="輸入使用者 Email" className="flex-1 p-2 border border-yellow-300 rounded-lg text-sm bg-white" onKeyDown={(e) => e.key === 'Enter' && handleAddAdmin()} /><button onClick={handleAddAdmin} className="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-sm whitespace-nowrap">新增管理員</button></div>
                            <div className="bg-white rounded-lg border border-yellow-200 overflow-hidden"><ul className="divide-y divide-yellow-100">{rootAdmins.map(email => (<li key={email} className="px-4 py-3 flex justify-between items-center text-sm"><span className="flex items-center gap-2 font-bold text-slate-700"><ShieldCheck size={14} className="text-purple-600"/> {formatEmailPrefix(email)}</span><span className="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">系統預設</span></li>))}{cloudAdmins.map(email => (<li key={email} className="px-4 py-3 flex justify-between items-center text-sm"><span className="flex items-center gap-2 text-slate-700"><ShieldCheck size={14} className="text-yellow-600"/> {formatEmailPrefix(email)}</span><button onClick={() => confirmRemoveAdmin(email)} className="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition"><Trash2 size={16} /></button></li>))}</ul></div>
                        </div>
                    )}

                    {/* Editor Management Panel */}
                    {isAdmin && (
                        <div className="bg-blue-50 p-8 rounded-xl shadow-sm border border-blue-200">
                            <div className="flex items-center gap-3 mb-6"><div className="p-3 bg-blue-100 rounded-full"><User className="text-blue-700" size={24} /></div><div><h2 className="text-xl font-bold text-blue-900">編輯者權限管理</h2><p className="text-sm text-blue-700">可檢視與編輯所有資料，但不可使用 AI 與系統設定</p></div></div>
                            <div className="flex gap-2 mb-6"><input value={newEditorEmail} onChange={(e) => setNewEditorEmail(e.target.value)} placeholder="輸入使用者 Email" className="flex-1 p-2 border border-blue-300 rounded-lg text-sm bg-white" onKeyDown={(e) => e.key === 'Enter' && handleAddEditor()} /><button onClick={handleAddEditor} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm whitespace-nowrap">新增編輯者</button></div>
                            <div className="bg-white rounded-lg border border-blue-200 overflow-hidden"><ul className="divide-y divide-blue-100">{cloudEditors.length === 0 ? (<li className="px-4 py-3 text-sm text-slate-400">尚無編輯者</li>) : cloudEditors.map(email => (<li key={email} className="px-4 py-3 flex justify-between items-center text-sm"><span className="flex items-center gap-2 text-slate-700"><ShieldCheck size={14} className="text-blue-600"/> {formatEmailPrefix(email)}</span><button onClick={() => confirmRemoveEditor(email)} className="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition"><Trash2 size={16} /></button></li>))}</ul></div>
                        </div>
                    )}

                    {/* Global Options: Meeting Categories */}
                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex items-center gap-3 mb-6"><div className={`p-3 rounded-full ${isAdmin ? 'bg-emerald-100' : 'bg-slate-100'}`}>{isAdmin ? <ShieldCheck className="text-emerald-700" size={24} /> : <Lock className="text-slate-500" size={24} />}</div><div><h2 className="text-xl font-bold text-slate-800">全域下拉選單 - 會議分類</h2></div></div>
                        {isAdmin && (<div className="flex gap-2 mb-4"><input value={newCategory} onChange={(e) => setNewCategory(e.target.value)} placeholder="輸入新分類名稱" className="flex-1 p-2 border border-slate-300 rounded-lg" onKeyDown={(e) => e.key === 'Enter' && handleAddItem('meetingCategories', newCategory, categories, setCategories, setNewCategory)} /><button onClick={() => handleAddItem('meetingCategories', newCategory, categories, setCategories, setNewCategory)} className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">新增</button></div>)}
                        <div className="flex flex-wrap gap-2">{categories.map((cat, idx) => (<div key={idx} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full text-sm text-slate-700 border border-slate-200"><span>{cat}</span>{isAdmin && <button onClick={() => confirmDeleteItem('meetingCategories', cat, categories)} className="text-slate-400 hover:text-red-500"><X size={14} /></button>}</div>))}</div>
                    </div>

                    {/* Global Options: Task Sources */}
                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex items-center gap-3 mb-6"><div className={`p-3 rounded-full ${isAdmin ? 'bg-blue-100' : 'bg-slate-100'}`}>{isAdmin ? <ShieldCheck className="text-blue-700" size={24} /> : <Lock className="text-slate-500" size={24} />}</div><div><h2 className="text-xl font-bold text-slate-800">全域下拉選單 - 待辦來源</h2></div></div>
                        {isAdmin && (<div className="flex gap-2 mb-4"><input value={newTaskSource} onChange={(e) => setNewTaskSource(e.target.value)} placeholder="輸入新來源名稱" className="flex-1 p-2 border border-slate-300 rounded-lg" onKeyDown={(e) => e.key === 'Enter' && handleAddItem('taskSources', newTaskSource, taskSources, setTaskSources, setNewTaskSource)} /><button onClick={() => handleAddItem('taskSources', newTaskSource, taskSources, setTaskSources, setNewTaskSource)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">新增</button></div>)}
                        <div className="flex flex-wrap gap-2">{taskSources.map((src, idx) => (<div key={idx} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full text-sm text-slate-700 border border-slate-200"><span>{src}</span>{isAdmin && <button onClick={() => confirmDeleteItem('taskSources', src, taskSources)} className="text-slate-400 hover:text-red-500"><X size={14} /></button>}</div>))}</div>
                    </div>

                    {/* Global Options: Task Statuses */}
                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex items-center gap-3 mb-6"><div className={`p-3 rounded-full ${isAdmin ? 'bg-indigo-100' : 'bg-slate-100'}`}>{isAdmin ? <ShieldCheck className="text-indigo-700" size={24} /> : <Lock className="text-slate-500" size={24} />}</div><div><h2 className="text-xl font-bold text-slate-800">全域下拉選單 - 待辦狀態</h2></div></div>
                        {isAdmin && (<div className="flex gap-2 mb-4"><input value={newTaskStatus} onChange={(e) => setNewTaskStatus(e.target.value)} placeholder="輸入新狀態名稱" className="flex-1 p-2 border border-slate-300 rounded-lg" onKeyDown={(e) => e.key === 'Enter' && handleAddItem('taskStatuses', newTaskStatus, taskStatuses, setTaskStatuses, setNewTaskStatus)} /><button onClick={() => handleAddItem('taskStatuses', newTaskStatus, taskStatuses, setTaskStatuses, setNewTaskStatus)} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">新增</button></div>)}
                        <div className="flex flex-wrap gap-2">{taskStatuses.map((st, idx) => (<div key={idx} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full text-sm text-slate-700 border border-slate-200"><span>{st}</span>{isAdmin && <button onClick={() => confirmDeleteItem('taskStatuses', st, taskStatuses)} className="text-slate-400 hover:text-red-500"><X size={14} /></button>}</div>))}</div>
                    </div>
                </div>
            );
        };

        // --- 4. Main App Component (Must be last) ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('tasks'); 
            const [appInstance, setAppInstance] = useState(null);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [user, setUser] = useState(null);
            const [error, setError] = useState(null);
            const [connectionStatus, setConnectionStatus] = useState('初始化中...');
            const [isAuthChecking, setIsAuthChecking] = useState(true);
            const [cloudAdmins, setCloudAdmins] = useState([]);
            const [cloudEditors, setCloudEditors] = useState([]);
            const [locale, setLocale] = useState(() => localStorage.getItem(LOCALE_STORAGE_KEY) || DEFAULT_LOCALE);
            const localeConvertersRef = useRef(null);
            const originalLocaleTextRef = useRef(new WeakMap());
            const isLocaleUpdatingRef = useRef(false);

            const testConfig = useMemo(() => {
                const params = new URLSearchParams(window.location.search);
                return {
                    enabled: params.get('testMode') === '1',
                    userEmail: params.get('testUserEmail'),
                    forceAuthPage: params.get('testAuth') === '1'
                };
            }, []);
            
            useEffect(() => {
                if (testConfig.enabled) {
                    if (testConfig.forceAuthPage) {
                        setUser(null);
                        setConnectionStatus('測試模式');
                        setIsAuthChecking(false);
                        return;
                    }
                    setUser({ uid: 'test-mode', email: testConfig.userEmail || null });
                    setConnectionStatus('測試模式');
                    setIsAuthChecking(false);
                    return;
                }
                const initFirebase = async () => {
                    try {
                        const APP_NAME = 'work-tracker-app';
                        let app;
                        const existingApp = getApps().find(app => app.name === APP_NAME);
                        if (existingApp) {
                            app = existingApp;
                        } else {
                            app = initializeApp(DEFAULT_CONFIG, APP_NAME);
                        }
                        const authInstance = getAuth(app);
                        const dbInstance = getFirestore(app);
                        setAppInstance(app);
                        setAuth(authInstance);
                        setDb(dbInstance);
                        setConnectionStatus(navigator.onLine ? '連線中...' : '離線');
                        onAuthStateChanged(authInstance, (u) => {
                            setUser(u);
                            setIsAuthChecking(false);
                        });
                    } catch (err) {
                        console.error("Firebase Init Error:", err);
                        setError(`連線錯誤: ${err.message}`);
                        setConnectionStatus('連線錯誤');
                        setIsAuthChecking(false);
                    }
                };
                initFirebase();
            }, [testConfig.enabled, testConfig.userEmail]);

            useEffect(() => {
                if (!window.OpenCC) return;
                if (!localeConvertersRef.current) {
                    localeConvertersRef.current = {
                        toSimplified: window.OpenCC.Converter({ from: 'tw', to: 'cn' }),
                        toTraditional: window.OpenCC.Converter({ from: 'cn', to: 'tw' })
                    };
                }
            }, []);

            useEffect(() => {
                document.documentElement.lang = locale === 'zh-Hans' ? 'zh-CN' : 'zh-TW';
                localStorage.setItem(LOCALE_STORAGE_KEY, locale);
                if (!localeConvertersRef.current) return;
                applyLocaleToDocument(locale, localeConvertersRef.current, originalLocaleTextRef.current, isLocaleUpdatingRef);
                if (locale !== 'zh-Hans') return;
                const observer = new MutationObserver(() => {
                    applyLocaleToDocument(locale, localeConvertersRef.current, originalLocaleTextRef.current, isLocaleUpdatingRef);
                });
                observer.observe(document.body, { childList: true, subtree: true, characterData: true });
                return () => observer.disconnect();
            }, [locale]);

            useEffect(() => {
                if (!db || testConfig.enabled) return;
                const statusRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'connection');
                const unsubscribe = onSnapshot(
                    statusRef,
                    { includeMetadataChanges: true },
                    (docSnap) => {
                        if (docSnap.metadata.fromCache) {
                            setConnectionStatus(navigator.onLine ? '離線（快取）' : '離線');
                        } else {
                            setConnectionStatus('已連線');
                        }
                    },
                    (err) => {
                        console.error("Firebase Connection Error:", err);
                        setConnectionStatus('連線錯誤');
                    }
                );
                const handleOnline = () => setConnectionStatus('連線中...');
                const handleOffline = () => setConnectionStatus('離線');
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    unsubscribe();
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, [db, testConfig.enabled]);

            useEffect(() => {
                if (!db) return;
                const adminsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'admins');
                const unsubscribe = onSnapshot(adminsRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().list) {
                        setCloudAdmins(docSnap.data().list);
                    } else {
                        setCloudAdmins([]);
                    }
                });
                return () => unsubscribe();
            }, [db]);

            useEffect(() => {
                if (!db) return;
                const editorsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'editors');
                const unsubscribe = onSnapshot(editorsRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().list) {
                        setCloudEditors(docSnap.data().list);
                    } else {
                        setCloudEditors([]);
                    }
                });
                return () => unsubscribe();
            }, [db]);

            useEffect(() => {
                if (testConfig.enabled) return;
                if (!db || !user || !user.uid) return;
                const registerUser = async () => {
                    try {
                        const userRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'users', user.uid);
                        const snapshot = await getDoc(userRef);
                        const existingData = snapshot.exists() ? snapshot.data() : {};
                        const resolvedEmail = user.email || existingData.email;
                        const payload = {
                            uid: user.uid,
                            lastSeen: serverTimestamp(),
                            lastLoginAt: serverTimestamp()
                        };
                        if (resolvedEmail) {
                            payload.email = resolvedEmail;
                        }
                        if (!existingData.createdAt) {
                            payload.createdAt = serverTimestamp();
                        }
                        await setDoc(userRef, payload, { merge: true });
                    } catch (e) {
                        console.error("User Registry Error:", e);
                    }
                };
                registerUser();
            }, [db, user, testConfig.enabled]);

            const isUserAdmin = useMemo(() => checkIsAdmin(user, cloudAdmins), [user, cloudAdmins]);
            const isUserEditor = useMemo(() => checkIsEditor(user, cloudEditors), [user, cloudEditors]);
            const isUserPrivileged = isUserAdmin || isUserEditor;
            const userDisplayName = useMemo(() => formatEmailPrefix(user?.email), [user]);
            const connectionIndicatorClass = useMemo(() => {
                if (connectionStatus.includes('已連線')) return 'bg-emerald-400';
                if (connectionStatus.includes('離線')) return 'bg-red-400';
                if (connectionStatus.includes('測試模式')) return 'bg-amber-400';
                return 'bg-slate-400';
            }, [connectionStatus]);

            const handleSaveGeminiKey = (key) => {
                alert("API Key 已內建，無需設定！");
            };

            if (isAuthChecking) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 text-slate-500">
                        <Loader2 size={48} className="animate-spin mb-4 text-blue-600" />
                        <p>正在連線至系統...</p>
                    </div>
                );
            }

            if (!user) {
                return <AuthPage auth={auth} error={error} connectionStatus={connectionStatus} />;
            }

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-slate-800 flex flex-col md:flex-row" data-testid="app-shell">
                    <aside className="w-full md:w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col shadow-xl z-10">
                        <div className="p-6 border-b border-slate-700">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Database className="text-blue-400" />
                                工作紀錄中心
                            </h1>
                            <p className="text-xs text-slate-400 mt-2">Firebase 雲端同步版</p>
                            <div className="text-[11px] text-slate-400 mt-2 flex items-center gap-2" data-testid="firebase-status">
                                <span className={`inline-block w-2 h-2 rounded-full ${connectionIndicatorClass}`} />
                                <span>Firebase 連線狀態：{connectionStatus}</span>
                            </div>
                        </div>
                        <nav className="p-4 space-y-2 flex-1">
                            <NavButton active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} icon={<LayoutDashboard size={20} />} label="數據看板" />
                            <NavButton active={activeTab === 'tasks'} onClick={() => setActiveTab('tasks')} icon={<CheckCircle2 size={20} />} label="待辦事項" />
                            <NavButton active={activeTab === 'meetings'} onClick={() => setActiveTab('meetings')} icon={<Users size={20} />} label="會議記錄" />
                            
                            {isUserAdmin && (
                                <div className="pt-4 border-t border-slate-700 mt-4">
                                    <NavButton active={activeTab === 'settings'} onClick={() => setActiveTab('settings')} icon={<Settings size={20} />} label="系統設定" />
                                </div>
                            )}
                        </nav>
                        <div className="p-4 bg-slate-800 border-t border-slate-700">
                            <div className="flex items-center gap-2 mb-4">
                                <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold">
                                    {userDisplayName ? userDisplayName.charAt(0).toUpperCase() : 'U'}
                                </div>
                                <div className="overflow-hidden">
                                    <div className="text-sm font-bold truncate w-32" data-testid="user-display-name">{userDisplayName}</div>
                                    <div className="text-[10px] text-slate-400 flex items-center gap-1">
                                        {isUserAdmin ? (
                                            <span className="text-yellow-400 flex items-center gap-0.5"><ShieldCheck size={10}/> Admin</span>
                                        ) : isUserEditor ? (
                                            <span className="text-blue-400 flex items-center gap-0.5"><ShieldCheck size={10}/> Editor</span>
                                        ) : (
                                            'User'
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {!testConfig.enabled && auth && (
                                <button onClick={() => signOut(auth)} className="w-full text-xs flex items-center justify-center gap-2 py-2 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 transition mb-3">
                                    <LogOut size={14} /> 登出
                                </button>
                            )}

                            <div className="pt-3 border-t border-slate-700 text-[10px] text-slate-500 text-center">
                                <div className="flex items-center justify-between mb-3 text-[11px] text-slate-400" data-testid="locale-toggle">
                                    <span>語系</span>
                                    <button
                                        onClick={() => setLocale((prev) => (prev === 'zh-Hant' ? 'zh-Hans' : 'zh-Hant'))}
                                        className="px-2 py-1 rounded bg-slate-700 text-slate-200 hover:bg-slate-600 transition"
                                        data-testid="locale-toggle-button"
                                    >
                                        {locale === 'zh-Hant' ? '简体' : '繁體'}
                                    </button>
                                </div>
                                <p>System Creator: {SYSTEM_CREATOR}</p>
                                <p>Version: {APP_VERSION}</p>
                            </div>
                        </div>
                    </aside>
                    
                    <main className="flex-1 overflow-y-auto h-screen p-4 md:p-8 relative bg-slate-50/50">
                        {activeTab === 'dashboard' && <Dashboard db={db} user={user} canAccessAll={isUserPrivileged} isAdmin={isUserAdmin} />}
                        {activeTab === 'tasks' && (
                            <TaskManager
                                db={db}
                                user={user}
                                canAccessAll={isUserPrivileged}
                                isAdmin={isUserAdmin}
                                testConfig={testConfig}
                            />
                        )}
                        {activeTab === 'meetings' && <MeetingMinutes db={db} user={user} canAccessAll={isUserPrivileged} isAdmin={isUserAdmin} isRootAdmin={isUserAdmin} />}
                        {activeTab === 'settings' && (
                            isUserAdmin ? (
                                <SettingsPage db={db} user={user} isAdmin={isUserAdmin} cloudAdmins={cloudAdmins} cloudEditors={cloudEditors} rootAdmins={ROOT_ADMINS} onSaveGeminiKey={handleSaveGeminiKey} testConfig={testConfig} />
                            ) : (
                                <div className="flex flex-col items-center justify-center h-full text-slate-400">
                                    <ShieldAlert size={48} className="mb-4" />
                                    <h2 className="text-xl font-bold text-slate-600">權限不足</h2>
                                    <p>您沒有權限存取系統設定頁面。</p>
                                </div>
                            )
                        )}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
