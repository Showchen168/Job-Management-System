<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œç´€éŒ„ä¸­å¿ƒ V2.3.4</title>
    
    <!-- 1. å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

    <!-- 2. å¼•å…¥ React å’Œ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- è¨­å®š Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Microsoft JhengHei', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        #root { min-height: 100vh; }
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #64748b;
            font-family: sans-serif;
            flex-direction: column;
            gap: 1rem;
        }
        .error-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #fee2e2;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #fca5a5;
            z-index: 9999;
            max-width: 90%;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-container">
            <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <div>ç³»çµ±è¼‰å…¥ä¸­...</div>
        </div>
    </div>
    <div id="global-error" style="display:none;" class="error-box"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const errorDiv = document.getElementById('global-error');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `<strong>ç³»çµ±ç™¼ç”ŸéŒ¯èª¤:</strong><br/>${message}`;
            console.error('Global Error:', error);
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        
        import { initializeApp, getApps, getApp, deleteApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, collection, collectionGroup, addDoc, updateDoc, deleteDoc, doc, getDoc, setDoc, query, orderBy, onSnapshot, serverTimestamp, arrayUnion, arrayRemove 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { 
            getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        import { 
            CheckCircle2, Clock, AlertCircle, Calendar, Users, FileText, Settings, Plus, Save, X, Edit2, Trash2, Link as LinkIcon, ChevronRight, Database, RefreshCw, Check, ShieldAlert, Download, List, Search, ArrowRightLeft, LogIn, LogOut, UserPlus, Loader2, ExternalLink, ShieldCheck, Lock, UserCog, Image as ImageIcon, Info, User, Filter, Briefcase, LayoutDashboard, BarChart3, PieChart, Activity, Sparkles, Bot, Copy 
        } from 'https://esm.sh/lucide-react@0.294.0';

        // --- 0. System Constants ---
        const SYSTEM_CREATOR = "Show";
        const APP_VERSION = "V2.3.4"; // Updated: editor role access
        const GEMINI_API_KEY = "AIzaSyAsnzwjsrisZVpCvmTiQVeK9lIZLeissoY";

        // --- 1. Firebase Configuration ---
        const DEFAULT_CONFIG = {
            apiKey: "AIzaSyAGezrKXfKSwvh1Aauy-wrTr53e_WtuXVE",
            authDomain: "job-management-system-16741.firebaseapp.com",
            projectId: "job-management-system-16741",
            storageBucket: "job-management-system-16741.firebasestorage.app",
            messagingSenderId: "1042345096032",
            appId: "1:1042345096032:web:853c2d9c35c06b7dd9a405",
            measurementId: "G-FM8QW4LJ2T"
        };

        const ROOT_ADMINS = [
            "showchen@aivres.com",
        ];

        const checkIsAdmin = (user, cloudAdmins = []) => {
            if (!user || !user.email) return false;
            return ROOT_ADMINS.includes(user.email) || cloudAdmins.includes(user.email);
        };

        const checkIsEditor = (user, cloudEditors = []) => {
            if (!user || !user.email) return false;
            return cloudEditors.includes(user.email);
        };

        // --- Helper Functions ---
        const callGeminiAI = async (contentParts) => {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: contentParts }] })
                });
                if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'API request failed');
                }
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error;
            }
        };

        const cleanAIResponse = (text) => {
            if (!text) return "";
            return text
                .replace(/```[\s\S]*?```/g, (block) => block.replace(/```/g, '').trim())
                .replace(/!\[.*?\]\(.*?\)/g, '')               // ç§»é™¤åœ–ç‰‡æ¨™è¨˜
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')       // ç§»é™¤é€£çµæ ¼å¼
                .replace(/^>\s?/gm, '')                        // ç§»é™¤å¼•ç”¨
                .replace(/^#+\s+/gm, '')                       // ç§»é™¤æ¨™é¡Œæ¨™è¨˜ (#, ##, ###)
                .replace(/^\s*[-*+]\s+/gm, '')                 // ç§»é™¤ç„¡åºæ¸…å–®
                .replace(/^\s*\d+\.\s+/gm, '')                 // ç§»é™¤æœ‰åºæ¸…å–®
                .replace(/^\s*[â€¢ãƒ»â€§]\s+/gm, '')                 // ç§»é™¤ç‰¹æ®Šç¬¦è™Ÿæ¸…å–®
                .replace(/^\s*\|?[\s:-]+\|?\s*$/gm, '')         // ç§»é™¤è¡¨æ ¼åˆ†éš”ç·š
                .replace(/\|/g, ' ')                           // ç§»é™¤è¡¨æ ¼ç®¡ç·šç¬¦è™Ÿ
                .replace(/^[-*_]{3,}$/gm, '')                  // ç§»é™¤åˆ†éš”ç·š
                .replace(/(\*\*|__)(.*?)\1/g, '$2')             // ç§»é™¤ç²—é«”æ¨™è¨˜
                .replace(/(\*|_)(.*?)\1/g, '$2')               // ç§»é™¤æ–œé«”æ¨™è¨˜
                .replace(/~~(.*?)~~/g, '$1')                   // ç§»é™¤åˆªé™¤ç·š
                .replace(/`/g, '')                             // ç§»é™¤è¡Œå…§ä»£ç¢¼æ¨™è¨˜
                .replace(/\n{3,}/g, '\n\n')
                .trim();
        };

        const copyToClipboard = (text) => {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).catch(err => {
                    console.error('Async: Could not copy text: ', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        };

        const fallbackCopyTextToClipboard = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textArea);
        };

        const extractContentForAI = (htmlContent) => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const text = tempDiv.textContent || tempDiv.innerText || "";
            const images = [];
            const imgTags = tempDiv.getElementsByTagName('img');
            for (let i = 0; i < imgTags.length; i++) {
                const src = imgTags[i].src;
                if (src.startsWith('data:image/')) {
                    const parts = src.split(',');
                    if (parts.length === 2) {
                        const mimeMatch = parts[0].match(/:(.*?);/);
                        if (mimeMatch) {
                            images.push({ inlineData: { mimeType: mimeMatch[1], data: parts[1] } });
                        }
                    }
                }
            }
            return { text, images };
        };

        const exportToCSV = (data, filename, headers) => {
            if (!data || !data.length) return;
            const bom = '\uFEFF';
            const csvContent = [
                headers.map(h => h.label).join(','),
                ...data.map(row => 
                headers.map(h => {
                    let val = row[h.key] || '';
                    if (h.key === 'content' && typeof val === 'string') val = val.replace(/<[^>]+>/g, '');
                    if (typeof val === 'string' && (val.includes(',') || val.includes('\n'))) val = `"${val.replace(/"/g, '""')}"`;
                    return val;
                }).join(',')
                )
            ].join('\n');
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const MAX_WIDTH = 800;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        };

        // --- 2. Base Components (Defined First) ---

        const Modal = ({ isOpen, title, content, onConfirm, onCancel, confirmText = 'ç¢ºèª', cancelText = 'å–æ¶ˆ', type = 'confirm', children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
                <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden transform scale-100 transition-all flex flex-col max-h-[90vh]">
                    <div className="p-6 flex-shrink-0">
                    <div className="flex items-center gap-3 mb-3">
                        {type === 'danger' && <div className="p-2 bg-red-100 rounded-full text-red-600"><AlertCircle size={24} /></div>}
                        {type === 'confirm' && <div className="p-2 bg-blue-100 rounded-full text-blue-600"><Info size={24} /></div>}
                        {type === 'ai' && <div className="p-2 bg-purple-100 rounded-full text-purple-600"><Bot size={24} /></div>}
                        <h3 className={`text-lg font-bold ${type === 'danger' ? 'text-red-700' : 'text-slate-800'}`}>{title}</h3>
                    </div>
                    {content && <p className="text-slate-600 text-sm leading-relaxed ml-1 whitespace-pre-wrap">{content}</p>}
                    {children}
                    </div>
                    <div className="bg-slate-50 px-6 py-4 flex justify-end gap-3 border-t border-slate-100 flex-shrink-0">
                    {onCancel && <button onClick={onCancel} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition-colors">{cancelText}</button>}
                    <button onClick={onConfirm} className={`px-4 py-2 text-sm font-medium text-white rounded-lg shadow-sm transition-colors ${type === 'danger' ? 'bg-red-600 hover:bg-red-700' : type === 'ai' ? 'bg-purple-600 hover:bg-purple-700' : 'bg-blue-600 hover:bg-blue-700'}`}>{confirmText}</button>
                    </div>
                </div>
                </div>
            );
        };

        // æ–°å¢: CopyButton Component - æä¾›è¦–è¦ºå›é¥‹
        const CopyButton = ({ text }) => {
            const [copied, setCopied] = useState(false);
            const handleCopy = () => {
                copyToClipboard(text);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };
            return (
                <button 
                    onClick={handleCopy}
                    className={`mt-3 flex items-center gap-2 text-sm font-medium transition-colors ${copied ? 'text-green-600' : 'text-purple-600 hover:underline'}`}
                >
                    {copied ? <Check size={16} /> : <Copy size={16} />} 
                    {copied ? 'å·²è¤‡è£½æˆåŠŸï¼' : 'è¤‡è£½å ±å‘Šå…§å®¹'}
                </button>
            );
        };

        const NavButton = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${active ? 'bg-blue-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-800 hover:text-white'}`}>{icon}<span className="font-medium">{label}</span></button>
        );

        const ContentEditor = ({ value, onChange }) => {
            const editableRef = useRef(null);
            useEffect(() => {
                if (editableRef.current && editableRef.current.innerHTML !== value) {
                    editableRef.current.innerHTML = value || '';
                }
            }, [value]);
            const handlePaste = async (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = items[i].getAsFile();
                        const base64 = await compressImage(file);
                        if (base64.length > 800 * 1024) { alert("åœ–ç‰‡éå¤§"); return; }
                        document.execCommand('insertImage', false, base64);
                    }
                }
            };
            const handleInput = (e) => onChange(e.currentTarget.innerHTML);
            return (
                <div className="w-full p-3 border border-slate-300 rounded min-h-[150px] max-h-[400px] overflow-y-auto focus:outline-none focus:ring-2 focus:ring-emerald-500 prose prose-sm max-w-none bg-slate-50" contentEditable ref={editableRef} onInput={handleInput} onPaste={handlePaste} data-placeholder="è«‹è¼¸å…¥æœƒè­°å…§å®¹ï¼Œå¯ç›´æ¥è²¼ä¸Šåœ–ç‰‡..." />
            );
        };

        // --- 3. Sub-Components (Tasks & Meetings) ---

        const TaskForm = ({ initialData, onSave, onCancel, taskSources, taskStatuses }) => {
            const [formData, setFormData] = useState({
                title: '', assignee: '', status: 'Pending', source: '', assignedDate: new Date().toISOString().split('T')[0], dueDate: '', delayReason: '', progress: '', ...initialData
            });
            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-blue-100 mb-6">
                <h3 className="font-bold text-lg mb-4 text-slate-700">{initialData ? 'ç·¨è¼¯äº‹é …' : 'æ–°å¢äº‹é …'}</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="col-span-2 md:col-span-1"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">äº‹é …å…§å®¹ <span className="text-red-500">*</span></label><input name="title" value={formData.title} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div className="col-span-2 md:col-span-1"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">è² è²¬äºº <span className="text-red-500">*</span></label><input name="assignee" value={formData.assignee} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div className="col-span-2 md:col-span-1"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">ä¾†æº <span className="text-red-500">*</span></label><select name="source" value={formData.source} onChange={handleChange} className="w-full p-2 border rounded" required><option value="" disabled>è«‹é¸æ“‡ä¾†æº</option>{taskSources.map((s, i) => <option key={i} value={s}>{s}</option>)}</select></div>
                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">ç‹€æ…‹ <span className="text-red-500">*</span></label><select name="status" value={formData.status} onChange={handleChange} className="w-full p-2 border rounded" required><option value="" disabled>è«‹é¸æ“‡ç‹€æ…‹</option>{taskStatuses.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">äº¤è¾¦æ—¥æœŸ <span className="text-red-500">*</span></label><input type="date" name="assignedDate" value={formData.assignedDate} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">é è¨ˆå®Œæˆ <span className="text-red-500">*</span></label><input type="date" name="dueDate" value={formData.dueDate} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div className="col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">é€²å±•æ›´æ–° <span className="text-red-500">*</span></label><textarea name="progress" value={formData.progress} onChange={handleChange} rows="2" className="w-full p-2 border rounded" required /></div>
                    <div className="col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase mb-1 text-slate-400">å»¶é²åŸå›  (é¸å¡«)</label><input name="delayReason" value={formData.delayReason} onChange={handleChange} className="w-full p-2 border border-slate-200 bg-slate-50 rounded" placeholder="éå¿…å¡«" /></div>
                </div>
                <div className="flex justify-end gap-3 mt-6"><button onClick={onCancel} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">å–æ¶ˆ</button><button onClick={() => onSave(formData)} className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2"><Save size={18} /> å„²å­˜</button></div>
                </div>
            );
        };

        const TaskRow = ({ task, onEdit, onDelete }) => {
            const getStatusColor = (status) => {
                const s = status.toLowerCase();
                if (s.includes('done') || s.includes('complete') || s.includes('å®Œæˆ')) return 'bg-green-100 text-green-700 border-green-200';
                if (s.includes('on-going') || s.includes('process') || s.includes('é€²è¡Œ')) return 'bg-blue-100 text-blue-700 border-blue-200';
                if (s.includes('pending') || s.includes('wait') || s.includes('å¾…')) return 'bg-yellow-100 text-yellow-700 border-yellow-200';
                return 'bg-gray-100 text-gray-700 border-gray-200';
            };
            return (
                <tr className="hover:bg-slate-50 transition-colors">
                <td className="px-6 py-4 whitespace-nowrap"><span className={`px-2 py-1 rounded-full text-xs font-bold border ${getStatusColor(task.status)}`}>{task.status}</span></td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{task.source || '-'}</td>
                <td className="px-6 py-4">
                    <div className="font-medium text-slate-800 max-w-xs truncate" title={task.title}>{task.title}</div>
                    {task.createdByEmail && <div className="text-[10px] text-slate-400 mt-1 flex items-center gap-1"><User size={10} /> {task.createdByEmail}</div>}
                </td>
                <td className="px-6 py-4 whitespace-nowrap">{task.assignee || '-'}</td>
                <td className="px-6 py-4 whitespace-nowrap">{task.assignedDate}</td>
                <td className="px-6 py-4 whitespace-nowrap"><span className={task.dueDate && new Date(task.dueDate) < new Date() && !task.status.toLowerCase().includes('done') ? 'text-red-600 font-bold' : ''}>{task.dueDate || '-'}</span></td>
                <td className="px-6 py-4 max-w-xs"><div className="flex flex-col gap-1">{task.progress && <div className="text-xs text-slate-600 truncate" title={task.progress}>{task.progress}</div>}{task.delayReason && (<div className="flex items-center gap-1 text-xs text-red-500 truncate" title={task.delayReason}><AlertCircle size={12} /> {task.delayReason}</div>)}</div></td>
                <td className="px-6 py-4 text-right whitespace-nowrap"><div className="flex justify-end gap-2"><button onClick={onEdit} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded transition"><Edit2 size={16} /></button><button onClick={onDelete} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition"><Trash2 size={16} /></button></div></td>
                </tr>
            );
        };

        const MeetingForm = ({ initialData, onSave, onCancel, categories }) => {
            const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], host: '', attendees: '', topic: '', content: '', category: categories[0] || '', ...initialData });
            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleContentChange = (newContent) => setFormData(prev => ({ ...prev, content: newContent }));
            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-emerald-100 mb-6">
                <h3 className="font-bold text-lg mb-4 text-slate-700">{initialData ? 'ç·¨è¼¯æœƒè­°è¨˜éŒ„' : 'æ–°å¢æœƒè­°è¨˜éŒ„'}</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="col-span-2 md:col-span-1"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">ä¸»é¡Œ <span className="text-red-500">*</span></label><input name="topic" value={formData.topic} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div className="col-span-2 md:col-span-1"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">åˆ†é¡ <span className="text-red-500">*</span></label><select name="category" value={formData.category} onChange={handleChange} className="w-full p-2 border rounded" required><option value="" disabled>è«‹é¸æ“‡åˆ†é¡</option>{categories.map((cat, i) => <option key={i} value={cat}>{cat}</option>)}</select></div>
                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">æ—¥æœŸ <span className="text-red-500">*</span></label><input type="date" name="date" value={formData.date} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">ä¸»æŒäºº <span className="text-red-500">*</span></label><input name="host" value={formData.host} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div className="col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase mb-1">åƒæœƒäººå“¡ <span className="text-red-500">*</span></label><input name="attendees" value={formData.attendees} onChange={handleChange} className="w-full p-2 border rounded" required /></div>
                    <div className="col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase mb-1 flex items-center justify-between"><span>å…§å®¹ (æ”¯æ´åœ–ç‰‡è²¼ä¸Š) <span className="text-red-500">*</span></span><span className="text-[10px] font-normal text-slate-400 flex items-center gap-1"><ImageIcon size={10}/> è²¼ä¸Šæˆªåœ–æœƒè‡ªå‹•å£“ç¸®</span></label><ContentEditor value={formData.content} onChange={handleContentChange} /></div>
                </div>
                <div className="flex justify-end gap-3 mt-6"><button onClick={onCancel} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">å–æ¶ˆ</button><button onClick={() => onSave(formData)} className="px-6 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 flex items-center gap-2"><Save size={18} /> å„²å­˜</button></div>
                </div>
            );
        };

        const MeetingRow = ({ meeting, onEdit, onDelete }) => {
            const [expanded, setExpanded] = useState(false);
            return (
                <div className="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden group">
                <div className="p-4 flex items-center justify-between cursor-pointer hover:bg-slate-50" onClick={() => setExpanded(!expanded)}>
                    <div className="flex items-center gap-4 flex-1">
                    <div className="flex flex-col items-center justify-center bg-emerald-50 text-emerald-700 w-16 h-16 rounded-lg border border-emerald-100 flex-shrink-0"><span className="text-xs font-bold uppercase">{new Date(meeting.date).toLocaleString('default', { month: 'short' })}</span><span className="text-xl font-bold">{new Date(meeting.date).getDate()}</span></div>
                    <div><div className="flex items-center gap-2">{meeting.category && <span className="text-xs px-2 py-0.5 bg-slate-100 text-slate-600 rounded border border-slate-200">{meeting.category}</span>}<h3 className="font-bold text-slate-800">{meeting.topic}</h3></div><p className="text-sm text-slate-500 flex gap-2 mt-1"><span>{meeting.host}</span><span>â€¢</span><span className="line-clamp-1 max-w-[200px]">{meeting.attendees}</span></p>{meeting.createdByEmail && <div className="text-[10px] text-slate-400 mt-1 flex items-center gap-1"><User size={10} /> {meeting.createdByEmail}</div>}</div>
                    </div>
                    <div className="flex items-center gap-4"><ChevronRight size={20} className={`text-slate-400 transition-transform ${expanded ? 'rotate-90' : ''}`} /></div>
                </div>
                {expanded && (
                    <div className="p-4 pt-0 border-t border-slate-100 bg-slate-50">
                    <div className="mt-4 text-sm text-slate-700 leading-relaxed bg-white p-4 rounded border border-slate-200 prose prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: meeting.content || "ç„¡è©³ç´°å…§å®¹" }} />
                    <div className="mt-4 flex justify-end gap-2 border-t border-slate-200 pt-3"><button onClick={onEdit} className="px-3 py-1.5 text-sm bg-white border border-slate-300 rounded hover:bg-slate-100 text-slate-600">ç·¨è¼¯</button><button onClick={onDelete} className="px-3 py-1.5 text-sm bg-red-50 border border-red-200 rounded hover:bg-red-100 text-red-600">åˆªé™¤</button></div>
                    </div>
                )}
                </div>
            );
        };

        // --- 4. Page Components (AuthPage Defined Here) ---
        
        const AuthPage = ({ auth, error }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setAuthError('');
                setLoading(true);
                try {
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    console.error("Auth Error:", err);
                    let msg = err.message;
                    if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found') msg = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤';
                    if (err.code === 'auth/email-already-in-use') msg = 'æ­¤ Email å·²è¢«è¨»å†Š';
                    if (err.code === 'auth/weak-password') msg = 'å¯†ç¢¼å¤ªçŸ­ (è‡³å°‘6ä½)';
                    if (err.code === 'auth/operation-not-allowed') msg = 'ç³»çµ±éŒ¯èª¤ï¼šè«‹è¯ç¹«ç®¡ç†å“¡é–‹å•Ÿ Email ç™»å…¥åŠŸèƒ½';
                    setAuthError(msg);
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden">
                    <div className="bg-slate-900 p-8 text-center">
                    <div className="inline-flex p-3 bg-blue-600 rounded-full mb-4 shadow-lg">
                        <Database size={32} className="text-white" />
                    </div>
                    <h1 className="text-2xl font-bold text-white mb-2">å·¥ä½œç´€éŒ„ä¸­å¿ƒ</h1>
                    <p className="text-slate-400 text-sm">è«‹ç™»å…¥ä»¥å­˜å–æ‚¨çš„å·¥ä½œè³‡æ–™</p>
                    </div>
                    <div className="p-8">
                    {error && <div className="mb-4 p-3 bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg flex gap-2"><AlertCircle size={16} className="mt-0.5 flex-shrink-0" />{error}</div>}
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="block text-sm font-medium text-slate-700 mb-1">Email ä¿¡ç®±</label><input type="email" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                        <div><label className="block text-sm font-medium text-slate-700 mb-1">å¯†ç¢¼</label><input type="password" required className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" value={password} onChange={(e) => setPassword(e.target.value)} /></div>
                        {authError && <div className="text-red-500 text-sm flex items-center gap-1"><AlertCircle size={14} /> {authError}</div>}
                        <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2 disabled:opacity-50">{loading && <Loader2 size={18} className="animate-spin" />}{isLogin ? 'ç™»å…¥ç³»çµ±' : 'è¨»å†Šå¸³è™Ÿ'}</button>
                    </form>
                    <div className="mt-6 text-center text-sm text-slate-500">{isLogin ? 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ' : 'å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿ'}<button onClick={() => { setIsLogin(!isLogin); setAuthError(''); }} className="ml-2 text-blue-600 font-bold hover:underline">{isLogin ? 'ç«‹å³è¨»å†Š' : 'è¿”å›ç™»å…¥'}</button></div>
                    </div>
                </div>
                </div>
            );
        };

        const Dashboard = ({ db, user, canAccessAll, isAdmin }) => {
            const [taskStats, setTaskStats] = useState({ total: 0, byStatus: {}, bySource: {} });
            const [meetingStats, setMeetingStats] = useState({ total: 0, byCategory: {} });

            useEffect(() => {
                if (!db || !user) return;
                const qTasks = canAccessAll 
                    ? query(collectionGroup(db, 'tasks')) 
                    : query(collection(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'tasks'));
                const unsubTasks = onSnapshot(qTasks, (snapshot) => {
                    let t = 0; let sources = {}; let statuses = {};
                    snapshot.forEach(doc => {
                        const data = doc.data(); t++;
                        const status = data.status || 'æœªå®šç¾©'; statuses[status] = (statuses[status] || 0) + 1;
                        const src = data.source || 'æœªåˆ†é¡'; sources[src] = (sources[src] || 0) + 1;
                    });
                    setTaskStats({ total: t, byStatus: statuses, bySource: sources });
                });
                const qMeetings = canAccessAll
                    ? query(collectionGroup(db, 'meetings'))
                    : query(collection(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'meetings'));
                const unsubMeetings = onSnapshot(qMeetings, (snapshot) => {
                    let t = 0; let cats = {};
                    snapshot.forEach(doc => {
                        const data = doc.data(); t++;
                        const c = data.category || 'æœªåˆ†é¡'; cats[c] = (cats[c] || 0) + 1;
                    });
                    setMeetingStats({ total: t, byCategory: cats });
                });
                return () => { unsubTasks(); unsubMeetings(); };
            }, [db, user, canAccessAll]);

            return (
                <div className="space-y-6 animate-in fade-in">
                    <div className="flex items-center gap-2"><h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><LayoutDashboard className="text-blue-600"/> æ•¸æ“šçœ‹æ¿</h2>{canAccessAll && <span className={`text-xs px-2 py-1 rounded-full font-bold ${isAdmin ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}`}>{isAdmin ? 'Admin View (All Data)' : 'Editor View (All Data)'}</span>}</div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><div className="text-slate-500 text-sm font-bold uppercase mb-2">ç¸½å¾…è¾¦äº‹é …</div><div className="text-4xl font-bold text-slate-800">{taskStats.total}</div></div>
                        {Object.entries(taskStats.byStatus).slice(0, 3).map(([status, count], i) => {
                            const colors = ['bg-yellow-50 border-yellow-200 text-yellow-800', 'bg-blue-50 border-blue-200 text-blue-800', 'bg-green-50 border-green-200 text-green-800'];
                            return (<div key={status} className={`p-6 rounded-xl shadow-sm border ${colors[i % colors.length]}`}><div className="text-sm font-bold uppercase mb-2 opacity-80">{status}</div><div className="text-4xl font-bold">{count}</div></div>);
                        })}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><BarChart3 size={20}/> å¾…è¾¦äº‹é …ä¾†æºåˆ†æ</h3>
                            <div className="space-y-3">{Object.keys(taskStats.bySource).length === 0 ? <p className="text-slate-400 text-sm">æš«ç„¡è³‡æ–™</p> : Object.entries(taskStats.bySource).map(([src, count]) => (<div key={src}><div className="flex justify-between text-sm mb-1"><span className="text-slate-600">{src}</span><span className="font-bold text-slate-800">{count}</span></div><div className="w-full bg-slate-100 rounded-full h-2"><div className="bg-blue-500 h-2 rounded-full" style={{ width: `${(count / taskStats.total) * 100}%` }}></div></div></div>))}</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><PieChart size={20}/> æœƒè­°é¡å‹çµ±è¨ˆ</h3>
                            <div className="flex items-center justify-between mb-6"><div><div className="text-3xl font-bold text-slate-800">{meetingStats.total}</div><div className="text-xs text-slate-500">ç¸½æœƒè­°å ´æ¬¡</div></div><div className="p-3 bg-emerald-100 rounded-full text-emerald-600"><Users size={24}/></div></div>
                            <div className="space-y-2">{Object.keys(meetingStats.byCategory).length === 0 ? <p className="text-slate-400 text-sm">æš«ç„¡è³‡æ–™</p> : Object.entries(meetingStats.byCategory).map(([cat, count]) => (<div key={cat} className="flex justify-between items-center text-sm p-2 hover:bg-slate-50 rounded border border-transparent hover:border-slate-100"><span className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-emerald-500"></div>{cat}</span><span className="font-mono font-bold text-slate-700">{count}</span></div>))}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const TaskManager = ({ db, user, canAccessAll, isAdmin }) => {
            const [tasks, setTasks] = useState([]);
            const [filteredTasks, setFilteredTasks] = useState([]);
            const [isEditing, setIsEditing] = useState(false);
            const [currentTask, setCurrentTask] = useState(null);
            const [modalConfig, setModalConfig] = useState({ isOpen: false });
            const [taskSources, setTaskSources] = useState(['Email', 'Meeting', 'Chat', 'Other']);
            const [taskStatuses, setTaskStatuses] = useState(['Pending', 'On-going', 'Done']);
            const isRootAdmin = ROOT_ADMINS.includes(user?.email);
            const [aiLoading, setAiLoading] = useState(false);
            const [aiReport, setAiReport] = useState('');
            const [filterStatus, setFilterStatus] = useState('All');
            const [searchQuery, setSearchQuery] = useState('');
            
            useEffect(() => {
                if (!db || !user) return;
                const q = canAccessAll 
                    ? query(collectionGroup(db, 'tasks'))
                    : query(collection(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'tasks'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, path: doc.ref.path, ...doc.data() }));
                data.sort((a, b) => { const ta = a.createdAt?.seconds || 0; const tb = b.createdAt?.seconds || 0; return tb - ta; });
                setTasks(data);
                }, (error) => console.error("Error tasks:", error));
                return () => unsubscribe();
            }, [db, user, canAccessAll]);

            useEffect(() => {
                if (!db) return;
                const settingsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'options');
                const unsubscribe = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) { const data = docSnap.data(); if (data.taskSources) setTaskSources(data.taskSources); if (data.taskStatuses) setTaskStatuses(data.taskStatuses); }
                });
                return () => unsubscribe();
            }, [db]);

            useEffect(() => {
                let res = tasks;
                if (filterStatus !== 'All') { res = res.filter(t => t.status === filterStatus); }
                if (searchQuery.trim()) { const lowerQ = searchQuery.toLowerCase(); res = res.filter(t => t.title.toLowerCase().includes(lowerQ) || (t.assignee && t.assignee.toLowerCase().includes(lowerQ)) || (t.createdByEmail && t.createdByEmail.toLowerCase().includes(lowerQ))); }
                setFilteredTasks(res);
            }, [tasks, filterStatus, searchQuery]);

            const handleGenerateReport = async () => {
                if (!filteredTasks.length) { setModalConfig({ isOpen: true, type: 'confirm', title: 'ç„¡è³‡æ–™', content: "ç›®å‰åˆ—è¡¨ç‚ºç©ºã€‚", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "å¥½", onCancel: null }); return; }
                setAiLoading(true);
                setModalConfig({ isOpen: true, type: 'ai', title: 'AI æ­£åœ¨æ€è€ƒä¸­...', content: 'æ­£åœ¨æ’°å¯«å ±å‘Š...', onConfirm: null, confirmText: "", onCancel: null });
                const taskData = filteredTasks.map((t, index) => {
                    const assignee = t.assignee || t.createdByEmail || 'Unknown';
                    const dueDate = t.dueDate || 'æœªæä¾›';
                    const status = t.status || 'æœªæä¾›';
                    const progress = t.progress || 'æœªæä¾›';
                    return `é …ç›®${index + 1}ï¼šäº‹é …=${t.title}ï¼›è² è²¬äºº=${assignee}ï¼›æˆªæ­¢æ—¥=${dueDate}ï¼›ç‹€æ…‹=${status}ï¼›é€²åº¦=${progress}`;
                }).join('\n');
                const prompt = [
                    "### è§’è‰²",
                    "ä½ æ˜¯ä¸€ä½çµæœå°å‘çš„ã€Œè³‡æ·±å°ˆæ¡ˆç¶“ç† (Senior Project Manager)ã€ï¼Œæ“…é•·å°‡é›¶æ•£çš„å·¥ä½œæ—¥èªŒã€èŠå¤©è¨˜éŒ„æˆ–éƒµä»¶å…§å®¹ï¼Œè½‰åŒ–ç‚ºé«˜å«é‡‘é‡çš„ã€Œç®¡ç†å±¤å½™å ±æ‘˜è¦ã€ã€‚",
                    "",
                    "### ä»»å‹™",
                    "è«‹æ ¹æ“šæä¾›çš„ [å·¥ä½œæ—¥èªŒ/å°è©±è¨˜éŒ„/é›¶æ•£ç­†è¨˜]ï¼Œæ•´ç†å‡ºä¸€ä»½æœ€æ–°çš„å·¥ä½œé€²å±•å ±å‘Šã€‚ä½ çš„ç›®æ¨™æ˜¯å±•ç¾ç”¢å‡ºèˆ‡åƒ¹å€¼ï¼Œè€Œéåƒ…åƒ…åˆ—å‡ºåšäº†ä»€éº¼å‹•ä½œã€‚",
                    "",
                    "### æƒ…å¢ƒ",
                    "- é–±è®€å°è±¡ç‚ºéƒ¨é–€ä¸»ç®¡æˆ–å®¢æˆ¶ï¼Œæ™‚é–“å¯¶è²´ï¼Œéœ€è¦ä¸€çœ¼çœ‹åˆ°é‡é»ã€‚",
                    "- åŸå§‹è¼¸å…¥å¯èƒ½åŒ…å«åŸ·è¡Œç´°ç¯€ï¼ˆå¦‚ï¼šä¿®å¾©äº†æŸè¡Œä»£ç¢¼ï¼‰ï¼Œä½ éœ€è¦å°‡å…¶è½‰åŒ–ç‚ºæ¥­å‹™èªè¨€ï¼ˆå¦‚ï¼šæå‡äº†ç³»çµ±ç©©å®šæ€§ï¼‰ã€‚",
                    "",
                    "### é™åˆ¶æ¢ä»¶",
                    "- **è¼¸å‡ºæ ¼å¼**ï¼šMarkdown æ¢åˆ—å¼ã€‚",
                    "- **èªæ°£é¢¨æ ¼**ï¼šè‡ªä¿¡ã€ç²¾ç°¡ã€å®¢è§€ (Executive Summary Style)ã€‚",
                    "- **æ ¸å¿ƒåŸå‰‡**ï¼š",
                    "  1. **é‡åŒ–æˆæœ**ï¼šå¦‚æœæœ‰æ•¸å­—ï¼ˆæ™‚é–“ã€æ•¸é‡ã€ç™¾åˆ†æ¯”ï¼‰ï¼Œå‹™å¿…å¼·èª¿ã€‚",
                    "  2. **å€åˆ†è¼•é‡**ï¼šå°‡ã€Œå·²å®Œæˆçš„é‡è¦æˆæœã€ç½®é ‚ï¼Œç‘£ç¢äº‹å‹™æ¦‚æ‹¬å¸¶éã€‚",
                    "  3. **å¼·èª¿é˜»ç¤™**ï¼šè‹¥æœ‰å¡é—œä¹‹è™•ï¼Œå¿…é ˆæ˜ç¢ºæŒ‡å‡ºéœ€è¦ä»€éº¼è³‡æºæˆ–å”åŠ©ã€‚",
                    "",
                    "### è¼¸å‡ºç¯„æœ¬æ¶æ§‹",
                    "# [å°ˆæ¡ˆ/éƒ¨é–€åç¨±] å·¥ä½œé€²åº¦å½™å ±",
                    "",
                    "**ğŸ“… å ±å‘Šé€±æœŸ**ï¼š[æ—¥æœŸç¯„åœ]",
                    "**ğŸš¦ æ•´é«”ç‹€æ…‹**ï¼š[æ­£å¸¸(ç¶ ç‡ˆ) / æœ‰é¢¨éšª(é»ƒç‡ˆ) / åš´é‡å»¶é²(ç´…ç‡ˆ)]",
                    "",
                    "## 1. æ ¸å¿ƒæˆæœ (Key Achievements)",
                    "> èªªæ˜æœ¬é€±æœŸå…§ã€Œå®Œæˆã€çš„æœ€é‡è¦äº‹é …ï¼Œå¼·èª¿å¸¶ä¾†çš„åƒ¹å€¼ã€‚",
                    "- âœ… [æˆæœ 1]ï¼š[å…·é«”èªªæ˜ï¼Œä¾‹å¦‚ï¼šå®Œæˆé¦–é æ”¹ç‰ˆï¼Œè¼‰å…¥é€Ÿåº¦æå‡ 20%]",
                    "- âœ… [æˆæœ 2]ï¼š...",
                    "",
                    "## 2. é€²è¡Œä¸­å·¥ä½œ (Work in Progress)",
                    "> èªªæ˜ç›®å‰æ­£åœ¨è™•ç†çš„å¤§å‹ä»»å‹™åŠå…¶é è¨ˆå®Œæˆæ™‚é–“ã€‚",
                    "- ğŸ”„ [ä»»å‹™åç¨±]ï¼šç›®å‰é€²åº¦ [XX]%ï¼Œé è¨ˆ [æ—¥æœŸ] å®Œæˆã€‚",
                    "",
                    "## 3. é¢¨éšªèˆ‡é˜»ç¤™ (Blockers & Risks)",
                    "> **(é‡è¦)** éœ€è¦ä¸»ç®¡é—œæ³¨æˆ–å”åŠ©çš„åœ°æ–¹ã€‚",
                    "- âš ï¸ [é˜»ç¤™æè¿°]ï¼š[å½±éŸ¿ç¯„åœ] -> [å»ºè­°è§£æ±ºæ–¹æ¡ˆ/éœ€è¦çš„å”åŠ©]",
                    "",
                    "## 4. ä¸‹éšæ®µè¨ˆåŠƒ (Next Steps)",
                    "- [ ] [è¨ˆåŠƒ 1]",
                    "- [ ] [è¨ˆåŠƒ 2]",
                    "",
                    "---",
                    "",
                    "### åŸå§‹å·¥ä½œå…§å®¹",
                    "è«‹æ ¹æ“šä»¥ä¸‹å…§å®¹é€²è¡Œæ•´ç†ï¼š",
                    "",
                    taskData
                ].join('\n');
                try {
                    const resultRaw = await callGeminiAI([{ text: prompt }]);
                    const result = cleanAIResponse(resultRaw);
                    setAiReport(result);
                    setModalConfig({ 
                        isOpen: true, type: 'ai', title: 'AI æ™ºèƒ½é€²åº¦ç¸½çµ', content: null, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null,
                        children: (<div className="mt-4"><div className="bg-slate-50 p-4 rounded-lg border border-slate-200 text-sm whitespace-pre-wrap max-h-[60vh] overflow-y-auto">{result}</div><CopyButton text={result} /></div>)
                    });
                } catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: 'ç”Ÿæˆå¤±æ•—', content: e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); }
                setAiLoading(false);
            };

            const handleSave = async (formData) => {
                if (!formData.title?.trim() || !formData.assignee?.trim() || !formData.source || !formData.status || !formData.assignedDate || !formData.dueDate || !formData.progress?.trim()) {
                    setModalConfig({ isOpen: true, type: 'danger', title: 'é©—è­‰éŒ¯èª¤', content: "è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "å¥½", onCancel: null });
                    return;
                }
                try {
                if (formData.id && formData.path) {
                    const docRef = doc(db, formData.path);
                    await updateDoc(docRef, { ...formData, updatedAt: serverTimestamp() });
                } else {
                    const collectionRef = collection(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'tasks');
                    await addDoc(collectionRef, { ...formData, updatedAt: serverTimestamp(), createdAt: serverTimestamp(), createdByEmail: user.email });
                }
                setIsEditing(false); setCurrentTask(null);
                } catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); }
            };

            const confirmDelete = (task) => {
                setModalConfig({ isOpen: true, type: 'danger', title: 'ç¢ºèªåˆªé™¤', content: 'ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®ï¼Ÿ', onConfirm: () => executeDelete(task), onCancel: () => setModalConfig({ isOpen: false }) });
            };

            const executeDelete = async (task) => {
                setModalConfig({ isOpen: false });
                try {
                if (task.path) { await deleteDoc(doc(db, task.path)); } else { await deleteDoc(doc(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'tasks', task.id)); }
                } catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); }
            };

            const handleExport = () => { 
                const headers = [{key:'status',label:'ç‹€æ…‹'},{key:'title',label:'äº‹é …'},{key:'assignee',label:'è² è²¬äºº'},{key:'createdByEmail',label:'å»ºç«‹è€…'}]; 
                exportToCSV(filteredTasks, 'WorkTasks', headers); 
            };

            return (
                <div className="space-y-6 animate-in fade-in">
                <Modal {...modalConfig} />
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div className="flex items-center gap-2"><h2 className="text-2xl font-bold text-slate-800">å·¥ä½œå¾…è¾¦äº‹é …</h2>{canAccessAll && <span className={`text-xs px-2 py-1 rounded-full font-bold ${isAdmin ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}`}>{isAdmin ? 'Admin View' : 'Editor View'}</span>}</div>
                    <div className="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                        <div className="flex items-center gap-2 bg-white border border-slate-300 rounded-lg px-2 py-1.5 shadow-sm w-full sm:w-auto"><Search size={16} className="text-slate-400" /><input className="outline-none text-sm w-full sm:w-32" placeholder="æœå°‹..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} /></div>
                        <div className="flex items-center gap-2 bg-white border border-slate-300 rounded-lg px-2 py-1.5 shadow-sm w-full sm:w-auto"><Filter size={16} className="text-slate-400" /><select className="outline-none text-sm w-full sm:w-24 bg-transparent" value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)}><option value="All">å…¨éƒ¨ç‹€æ…‹</option>{taskStatuses.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                        {isAdmin && <button onClick={handleGenerateReport} className="flex items-center justify-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition shadow-sm w-full sm:w-auto">{aiLoading ? <Loader2 size={18} className="animate-spin"/> : <Sparkles size={18} />} AI ç¸½çµ</button>}
                        <button onClick={handleExport} className="flex items-center justify-center gap-2 bg-white text-slate-600 border border-slate-300 px-4 py-2 rounded-lg hover:bg-slate-50 transition shadow-sm w-full sm:w-auto"><Download size={18} /> åŒ¯å‡º</button>
                        <button onClick={() => { setCurrentTask(null); setIsEditing(true); }} className="flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow-md w-full sm:w-auto"><Plus size={18} /> æ–°å¢</button>
                    </div>
                </div>
                {isEditing && <TaskForm initialData={currentTask} taskSources={taskSources} taskStatuses={taskStatuses} onSave={handleSave} onCancel={() => setIsEditing(false)} />}
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-slate-600">
                        <thead className="bg-slate-50 text-slate-700 font-bold uppercase text-xs">
                        <tr><th className="px-6 py-3">ç‹€æ…‹</th><th className="px-6 py-3">ä¾†æº</th><th className="px-6 py-3 min-w-[200px]">äº‹é …å…§å®¹ (å»ºç«‹è€…)</th><th className="px-6 py-3">è² è²¬äºº</th><th className="px-6 py-3">äº¤è¾¦æ—¥æœŸ</th><th className="px-6 py-3">é è¨ˆå®Œæˆ</th><th className="px-6 py-3 min-w-[150px]">é€²åº¦</th><th className="px-6 py-3 text-right">æ“ä½œ</th></tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                        {filteredTasks.map(task => (<TaskRow key={task.id} task={task} onEdit={() => { setCurrentTask(task); setIsEditing(true); }} onDelete={() => confirmDelete(task)} />))}
                        {filteredTasks.length === 0 && <tr><td colSpan="8" className="px-6 py-12 text-center text-slate-400">æ²’æœ‰è³‡æ–™</td></tr>}
                        </tbody>
                    </table>
                    </div>
                </div>
                </div>
            );
        };

        const MeetingMinutes = ({ db, user, canAccessAll, isAdmin, isRootAdmin }) => {
            const [meetings, setMeetings] = useState([]);
            const [filteredMeetings, setFilteredMeetings] = useState([]);
            const [isEditing, setIsEditing] = useState(false);
            const [currentMeeting, setCurrentMeeting] = useState(null);
            const [categories, setCategories] = useState(['å…§éƒ¨æœƒè­°', 'å®¢æˆ¶æœƒè­°', 'å°ˆæ¡ˆæª¢è¨']);
            const [modalConfig, setModalConfig] = useState({ isOpen: false });
            const [aiLoading, setAiLoading] = useState(false);
            const [filterCategory, setFilterCategory] = useState('All');
            const [searchQuery, setSearchQuery] = useState('');

            useEffect(() => {
                if (!db || !user) return;
                const q = canAccessAll
                    ? query(collectionGroup(db, 'meetings'))
                    : query(collection(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'meetings'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, path: doc.ref.path, ...doc.data() }));
                data.sort((a, b) => (new Date(b.date) - new Date(a.date)));
                setMeetings(data);
                }, (error) => console.error(error));
                return () => unsubscribe();
            }, [db, user, canAccessAll]);

            useEffect(() => {
                if (!db) return;
                const settingsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'options');
                const unsubscribe = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().meetingCategories) { setCategories(docSnap.data().meetingCategories); }
                });
                return () => unsubscribe();
            }, [db]);

            useEffect(() => {
                let res = meetings;
                if (filterCategory !== 'All') { res = res.filter(m => m.category === filterCategory); }
                if (searchQuery.trim()) { const lowerQ = searchQuery.toLowerCase(); res = res.filter(m => m.topic.toLowerCase().includes(lowerQ) || m.host.toLowerCase().includes(lowerQ) || (m.createdByEmail && m.createdByEmail.toLowerCase().includes(lowerQ))); }
                setFilteredMeetings(res);
            }, [meetings, filterCategory, searchQuery]);

            const handleGenerateMeetingReport = async () => {
                if (!filteredMeetings.length) { setModalConfig({ isOpen: true, type: 'confirm', title: 'ç„¡è³‡æ–™', content: "ç›®å‰åˆ—è¡¨ç‚ºç©ºã€‚", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "å¥½", onCancel: null }); return; }
                setAiLoading(true);
                setModalConfig({ isOpen: true, type: 'ai', title: 'AI æ­£åœ¨åˆ†æ...', content: 'æ­£åœ¨é–±è®€è¨˜éŒ„...', onConfirm: null, confirmText: "", onCancel: null });
                try {
                    const parts = [];
                    const meetingsToAnalyze = filteredMeetings.slice(0, 5); 
                    let promptText = [
                        "### è§’è‰²",
                        "ä½ æ˜¯ä¸€ä½æ“æœ‰ 10 å¹´ç¶“é©—çš„ã€Œè³‡æ·±é«˜éšè¡Œæ”¿ç§˜æ›¸ã€ï¼Œæ“…é•·è³‡è¨Šèƒå–ã€é‚è¼¯æ­¸ç´èˆ‡å•†å‹™æºé€šã€‚ä½ å…·å‚™å°‡é›¶æ•£ã€å£èªåŒ–çš„æœƒè­°å°è©±è½‰åŒ–ç‚ºæ¢ç†åˆ†æ˜ã€å…·å‚™åŸ·è¡ŒåŠ›çš„å°ˆæ¥­æœƒè­°ç´€éŒ„çš„èƒ½åŠ›ã€‚",
                        "",
                        "### ä»»å‹™",
                        "è«‹é–±è®€ä¸¦åˆ†ææä¾›çš„ [æœƒè­°è¨˜éŒ„/é€å­—ç¨¿/ç­†è¨˜]ï¼Œç”¢å‡ºä¸€ä»½çµæ§‹åŒ–çš„æœƒè­°ç´€è¦ã€‚ä½ çš„ç›®æ¨™æ˜¯è®“æœªåƒèˆ‡æœƒè­°çš„ä¸»ç®¡æˆ–åŒä»èƒ½åœ¨ 3 åˆ†é˜å…§æŒæ¡æœƒè­°é‡é»èˆ‡å¾ŒçºŒè¡Œå‹•ã€‚",
                        "",
                        "### æƒ…å¢ƒ",
                        "- åŸå§‹è³‡æ–™å¯èƒ½åŒ…å«å£èªè´…å­—ã€é›¢é¡Œè¨è«–æˆ–ä¸å®Œæ•´çš„å¥å­ï¼Œä½ éœ€è¦éæ¿¾é›œè¨Šï¼Œåƒ…ä¿ç•™æ ¸å¿ƒåƒ¹å€¼è³‡è¨Šã€‚",
                        "- è‹¥æœƒè­°ä¸­æ¶‰åŠå¤šå€‹è­°é¡Œï¼Œè«‹ä¾ç…§è­°é¡Œé€²è¡Œåˆ†é¡æ­¸ç´ã€‚",
                        "",
                        "### é™åˆ¶æ¢ä»¶",
                        "- **è¼¸å‡ºæ ¼å¼**ï¼šMarkdown æ ¼å¼ï¼ˆè«‹åƒè€ƒä¸‹æ–¹ç¯„æœ¬ï¼‰ã€‚",
                        "- **èªæ°£é¢¨æ ¼**ï¼šå°ˆæ¥­ã€å®¢è§€ã€ç°¡ç·´ï¼ˆBusiness Professionalï¼‰ã€‚",
                        "- **èªè¨€**ï¼šç¹é«”ä¸­æ–‡ï¼ˆå°ç£æ…£ç”¨èªï¼‰ã€‚",
                        "- **å…§å®¹è™•ç†**ï¼š",
                        "  1. é‡åˆ°æ¨¡ç³Šä¸æ¸…çš„æ—¥æœŸæˆ–äººåï¼Œè«‹æ¨™è¨»ã€Œ[éœ€ç¢ºèª]ã€ã€‚",
                        "  2. å¾…è¾¦äº‹é …ï¼ˆAction Itemsï¼‰å¿…é ˆåŒ…å«ã€Œè² è²¬äººã€èˆ‡ã€Œé è¨ˆå®Œæˆæ™‚é–“ã€ï¼ˆè‹¥ç„¡æåŠå‰‡æ¨™è¨»å¾…å®šï¼‰ã€‚",
                        "",
                        "### è¼¸å‡ºç¯„æœ¬æ¶æ§‹",
                        "# [æœƒè­°åç¨±] æœƒè­°ç´€è¦",
                        "",
                        "**æœƒè­°æ™‚é–“**ï¼š[YYYY/MM/DD]",
                        "**èˆ‡æœƒäººå“¡**ï¼š[åˆ—å‡ºåå–®]",
                        "",
                        "## 1. åŸ·è¡Œæ‘˜è¦ (Executive Summary)",
                        "> ç”¨ 3-5 å¥è©±æ¦‚æ‹¬æœ¬æ¬¡æœƒè­°çš„æ ¸å¿ƒç›®çš„èˆ‡æœ€é‡è¦çµè«–ã€‚",
                        "",
                        "## 2. é‡é»è­°é¡Œè¨è«–",
                        "* **è­°é¡Œä¸€ï¼š[è­°é¡Œåç¨±]**",
                        "    * è¨è«–é‡é»ï¼š...",
                        "    * é—œéµæ•¸æ“š/äº‹å¯¦ï¼š...",
                        "* **è­°é¡ŒäºŒï¼š[è­°é¡Œåç¨±]**",
                        "    * ...",
                        "",
                        "## 3. é—œéµæ±ºç­– (Key Decisions)",
                        "* [æ±ºç­– 1]",
                        "* [æ±ºç­– 2]",
                        "",
                        "## 4. å¾…è¾¦äº‹é … (Action Items)",
                        "| äº‹é …æè¿° | è² è²¬äºº | æˆªæ­¢æ—¥æœŸ |",
                        "| :--- | :--- | :--- |",
                        "| [å…·é«”è¡Œå‹•] | [å§“å] | [æ—¥æœŸ] |",
                        "",
                        "---",
                        "",
                        "### åŸå§‹æœƒè­°å…§å®¹",
                        "è«‹æ ¹æ“šä»¥ä¸‹å…§å®¹é€²è¡Œæ•´ç†ï¼š",
                        ""
                    ].join('\n');
                    meetingsToAnalyze.forEach((m, index) => {
                        const { text, images } = extractContentForAI(m.content);
                        promptText += `--- æœƒè­° ${index + 1}: ${m.date} ${m.topic} ---\n${text}\n\n`;
                        images.forEach(img => { parts.push(img); });
                    });
                    parts.unshift({ text: promptText });
                    const resultRaw = await callGeminiAI(parts);
                    const result = cleanAIResponse(resultRaw);
                    setModalConfig({ 
                        isOpen: true, type: 'ai', title: 'AI æœƒè­°æ™ºèƒ½ç¸½çµ', content: null, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null,
                        children: (<div className="mt-4"><div className="bg-slate-50 p-4 rounded-lg border border-slate-200 text-sm whitespace-pre-wrap max-h-[60vh] overflow-y-auto">{result}</div><CopyButton text={result} /></div>)
                    });
                } catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: 'ç”Ÿæˆå¤±æ•—', content: e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); }
                setAiLoading(false);
            };

            const handleSave = async (formData) => {
                if (!formData.content || formData.content.trim() === '') { setModalConfig({ isOpen: true, type: 'danger', title: 'é©—è­‰éŒ¯èª¤', content: "å…§å®¹å¿…å¡«", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "å¥½", onCancel: null }); return; }
                try {
                if (formData.id && formData.path) { await updateDoc(doc(db, formData.path), { ...formData, updatedAt: serverTimestamp() }); } 
                else { const collectionRef = collection(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'meetings'); await addDoc(collectionRef, { ...formData, updatedAt: serverTimestamp(), createdAt: serverTimestamp(), createdByEmail: user.email }); }
                setIsEditing(false); setCurrentMeeting(null);
                } catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); }
            };
            const confirmDelete = (meeting) => { setModalConfig({ isOpen: true, type: 'danger', title: 'ç¢ºèªåˆªé™¤', content: 'ç¢ºå®šè¦åˆªé™¤ï¼Ÿ', onConfirm: () => executeDelete(meeting), onCancel: () => setModalConfig({ isOpen: false }) }); };
            const executeDelete = async (meeting) => {
                setModalConfig({ isOpen: false });
                try { if (meeting.path) { await deleteDoc(doc(db, meeting.path)); } else { await deleteDoc(doc(db, 'artifacts', 'work-tracker-v1', 'users', user.uid, 'meetings', meeting.id)); } } 
                catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); }
            };
            const handleExport = () => { /* ... */ };

            return (
                <div className="space-y-6 animate-in fade-in">
                <Modal {...modalConfig} />
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div className="flex items-center gap-2"><h2 className="text-2xl font-bold text-slate-800">æœƒè­°è¨˜éŒ„å·¥å…·</h2>{canAccessAll && <span className={`text-xs px-2 py-1 rounded-full font-bold ${isAdmin ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}`}>{isAdmin ? 'Admin View' : 'Editor View'}</span>}</div>
                    <div className="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                        <div className="flex items-center gap-2 bg-white border border-slate-300 rounded-lg px-2 py-1.5 shadow-sm w-full sm:w-auto"><Search size={16} className="text-slate-400" /><input className="outline-none text-sm w-full sm:w-32" placeholder="æœå°‹..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} /></div>
                        {isAdmin && <button onClick={handleGenerateMeetingReport} className="flex items-center justify-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition shadow-sm w-full sm:w-auto">{aiLoading ? <Loader2 size={18} className="animate-spin"/> : <Sparkles size={18} />} AI ç¸½çµ</button>}
                        <button onClick={() => { setCurrentMeeting(null); setIsEditing(true); }} className="flex items-center justify-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition shadow-md w-full sm:w-auto"><Plus size={18} /> æ–°å¢</button>
                    </div>
                </div>
                {isEditing ? (
                    <MeetingForm initialData={currentMeeting} categories={categories} onSave={handleSave} onCancel={() => setIsEditing(false)} />
                ) : (
                    <div className="space-y-4">
                    {filteredMeetings.map(meeting => (
                        <MeetingRow key={meeting.id} meeting={meeting} onEdit={() => { setCurrentMeeting(meeting); setIsEditing(true); }} onDelete={() => confirmDelete(meeting)} />
                    ))}
                    {filteredMeetings.length === 0 && <div className="text-center py-12 text-slate-400 bg-white rounded-xl border border-dashed border-slate-300">æ²’æœ‰è³‡æ–™</div>}
                    </div>
                )}
                </div>
            );
        };

        const SettingsPage = ({ db, user, isAdmin, cloudAdmins, cloudEditors, rootAdmins, onSaveGeminiKey }) => {
            const [newCategory, setNewCategory] = useState('');
            const [categories, setCategories] = useState([]);
            const [newTaskSource, setNewTaskSource] = useState('');
            const [taskSources, setTaskSources] = useState([]);
            const [newTaskStatus, setNewTaskStatus] = useState('');
            const [taskStatuses, setTaskStatuses] = useState([]);
            const [newAdminEmail, setNewAdminEmail] = useState('');
            const [newEditorEmail, setNewEditorEmail] = useState('');
            const [modalConfig, setModalConfig] = useState({ isOpen: false });
            const [allUsers, setAllUsers] = useState([]);
            const [isUserListLoading, setIsUserListLoading] = useState(false);
            const [userListError, setUserListError] = useState('');

            useEffect(() => {
                if (!db) return;
                const settingsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'options');
                const unsubscribe = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setCategories(data.meetingCategories || ['å…§éƒ¨æœƒè­°', 'å®¢æˆ¶æœƒè­°', 'å°ˆæ¡ˆæª¢è¨', 'è…¦åŠ›æ¿€ç›ª']);
                        setTaskSources(data.taskSources || ['Email', 'Meeting', 'Chat', 'Other']);
                        setTaskStatuses(data.taskStatuses || ['Pending', 'On-going', 'Done']);
                    } else {
                        setCategories(['å…§éƒ¨æœƒè­°', 'å®¢æˆ¶æœƒè­°', 'å°ˆæ¡ˆæª¢è¨', 'è…¦åŠ›æ¿€ç›ª']);
                        setTaskSources(['Email', 'Meeting', 'Chat', 'Other']);
                        setTaskStatuses(['Pending', 'On-going', 'Done']);
                    }
                });
                return () => unsubscribe();
            }, [db]);

            useEffect(() => {
                if (!db || !isAdmin) return;
                setIsUserListLoading(true);
                setUserListError('');
                const q = query(collection(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'users'), orderBy('lastSeen', 'desc'));
                const unsubscribe = onSnapshot(
                    q,
                    (snapshot) => {
                        const users = snapshot.docs.map((docSnap) => {
                            const data = docSnap.data();
                            return {
                                ...data,
                                uid: data.uid || docSnap.id,
                                email: data.email || '(æœªå¡«å¯«)'
                            };
                        });
                        setAllUsers(users);
                        setIsUserListLoading(false);
                    },
                    (error) => {
                        console.error('User list snapshot error:', error);
                        setUserListError(`è®€å–å¤±æ•—ï¼š${error.message}`);
                        setIsUserListLoading(false);
                    }
                );
                return () => unsubscribe();
            }, [db, isAdmin]);

            const handleAddItem = async (field, newItem, list, setListState, setNewItemState) => {
                if (!newItem.trim()) return;
                if (list.includes(newItem.trim())) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: "æ­¤é¸é …å·²å­˜åœ¨", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); return; }
                try { await setDoc(doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'options'), { [field]: arrayUnion(newItem.trim()) }, { merge: true }); setNewItemState(''); } 
                catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: "æ›´æ–°å¤±æ•—ï¼š" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); }
            };
            const confirmDeleteItem = (field, itemToDelete, list) => { setModalConfig({ isOpen: true, type: 'danger', title: 'ç¢ºèªåˆªé™¤', content: `ç¢ºå®šè¦åˆªé™¤ã€Œ${itemToDelete}ã€å—ï¼Ÿ`, onConfirm: () => executeDeleteItem(field, itemToDelete, list), onCancel: () => setModalConfig({ isOpen: false }) }); };
            const executeDeleteItem = async (field, itemToDelete, list) => {
                setModalConfig({ isOpen: false });
                const settingsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'options');
                try {
                    const snapshot = await getDoc(settingsRef);
                    let updatedList = [];
                    if (snapshot.exists()) { updatedList = (snapshot.data()[field] || []).filter(c => c !== itemToDelete); } 
                    else { updatedList = list.filter(c => c !== itemToDelete); }
                    await setDoc(settingsRef, { [field]: updatedList }, { merge: true });
                } catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: "åˆªé™¤å¤±æ•—ï¼š" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); }
            };
            const handleAddAdmin = async () => {
                if (!newAdminEmail.trim() || !newAdminEmail.includes('@')) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: "Email æ ¼å¼éŒ¯èª¤", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); return; }
                if (cloudAdmins.includes(newAdminEmail.trim()) || rootAdmins.includes(newAdminEmail.trim())) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: "è©²ä½¿ç”¨è€…å·²ç¶“æ˜¯ç®¡ç†å“¡", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); return; }
                try { await setDoc(doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'admins'), { list: arrayUnion(newAdminEmail.trim()) }, { merge: true }); setNewAdminEmail(''); setModalConfig({ isOpen: true, type: 'confirm', title: 'æˆåŠŸ', content: `å·²å°‡ ${newAdminEmail} æ–°å¢ç‚ºç®¡ç†å“¡`, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "å¥½", onCancel: null }); } 
                catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: "æ“ä½œå¤±æ•—ï¼š" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); }
            };
            const confirmRemoveAdmin = (emailToRemove) => { setModalConfig({ isOpen: true, type: 'danger', title: 'ç§»é™¤æ¬Šé™', content: `ç¢ºå®šè¦ç§»é™¤ ${emailToRemove} çš„ç®¡ç†å“¡æ¬Šé™ï¼Ÿ`, onConfirm: () => executeRemoveAdmin(emailToRemove), onCancel: () => setModalConfig({ isOpen: false }) }); };
            const executeRemoveAdmin = async (emailToRemove) => {
                setModalConfig({ isOpen: false });
                const adminsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'admins');
                try { const snapshot = await getDoc(adminsRef); if (snapshot.exists()) { const updatedList = (snapshot.data().list || []).filter(e => e !== emailToRemove); await setDoc(adminsRef, { list: updatedList }, { merge: true }); } } 
                catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: "æ“ä½œå¤±æ•—ï¼š" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); }
            };

            const handleAddEditor = async () => {
                if (!newEditorEmail.trim() || !newEditorEmail.includes('@')) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: "Email æ ¼å¼éŒ¯èª¤", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); return; }
                if (cloudEditors.includes(newEditorEmail.trim())) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: "è©²ä½¿ç”¨è€…å·²ç¶“æ˜¯ç·¨è¼¯è€…", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); return; }
                if (cloudAdmins.includes(newEditorEmail.trim()) || rootAdmins.includes(newEditorEmail.trim())) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: "è©²ä½¿ç”¨è€…å·²ç¶“æ˜¯ç®¡ç†å“¡", onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); return; }
                try { await setDoc(doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'editors'), { list: arrayUnion(newEditorEmail.trim()) }, { merge: true }); setNewEditorEmail(''); setModalConfig({ isOpen: true, type: 'confirm', title: 'æˆåŠŸ', content: `å·²å°‡ ${newEditorEmail} æ–°å¢ç‚ºç·¨è¼¯è€…`, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "å¥½", onCancel: null }); } 
                catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: "æ“ä½œå¤±æ•—ï¼š" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); }
            };
            const confirmRemoveEditor = (emailToRemove) => { setModalConfig({ isOpen: true, type: 'danger', title: 'ç§»é™¤æ¬Šé™', content: `ç¢ºå®šè¦ç§»é™¤ ${emailToRemove} çš„ç·¨è¼¯è€…æ¬Šé™ï¼Ÿ`, onConfirm: () => executeRemoveEditor(emailToRemove), onCancel: () => setModalConfig({ isOpen: false }) }); };
            const executeRemoveEditor = async (emailToRemove) => {
                setModalConfig({ isOpen: false });
                const editorsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'editors');
                try { const snapshot = await getDoc(editorsRef); if (snapshot.exists()) { const updatedList = (snapshot.data().list || []).filter(e => e !== emailToRemove); await setDoc(editorsRef, { list: updatedList }, { merge: true }); } }
                catch (e) { setModalConfig({ isOpen: true, type: 'danger', title: 'éŒ¯èª¤', content: "æ“ä½œå¤±æ•—ï¼š" + e.message, onConfirm: () => setModalConfig({ isOpen: false }), confirmText: "é—œé–‰", onCancel: null }); }
            };

            return (
                <div className="max-w-3xl mx-auto space-y-8 pb-12">
                    <Modal {...modalConfig} />
                    
                    {/* User Registry List */}
                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex items-center gap-3 mb-6"><div className="p-3 bg-blue-100 rounded-full"><Users className="text-blue-700" size={24} /></div><div><h2 className="text-xl font-bold text-slate-800">å·²è¨»å†Šä½¿ç”¨è€…åˆ—è¡¨</h2><p className="text-sm text-slate-500">æª¢è¦–æ‰€æœ‰ç™»å…¥éç³»çµ±çš„å¸³è™Ÿ</p></div></div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left text-slate-600">
                                <thead className="bg-slate-50 text-slate-700 font-bold uppercase text-xs"><tr><th className="px-4 py-3">Email</th><th className="px-4 py-3">User UID</th><th className="px-4 py-3">æœ€å¾Œä¸Šç·š</th></tr></thead>
                                <tbody className="divide-y divide-slate-100">
                                    {userListError ? (
                                        <tr><td colSpan="3" className="px-4 py-4 text-center text-red-500">{userListError}</td></tr>
                                    ) : isUserListLoading ? (
                                        <tr><td colSpan="3" className="px-4 py-4 text-center text-slate-400">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>
                                    ) : allUsers.length === 0 ? (
                                        <tr><td colSpan="3" className="px-4 py-4 text-center text-slate-400">å°šç„¡è³‡æ–™</td></tr>
                                    ) : (
                                        allUsers.map((u) => {
                                            const lastSeenDate = u.lastSeen?.toDate
                                                ? u.lastSeen.toDate()
                                                : (u.lastSeen?.seconds ? new Date(u.lastSeen.seconds * 1000) : null);
                                            return (
                                                <tr key={u.uid} className="hover:bg-slate-50">
                                                    <td className="px-4 py-3 font-medium text-slate-800">{u.email}</td>
                                                    <td className="px-4 py-3 font-mono text-xs text-slate-500">{u.uid}</td>
                                                    <td className="px-4 py-3 text-xs">{lastSeenDate ? lastSeenDate.toLocaleString() : 'N/A'}</td>
                                                </tr>
                                            );
                                        })
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Admin Management Panel */}
                    {isAdmin && (
                        <div className="bg-yellow-50 p-8 rounded-xl shadow-sm border border-yellow-200">
                            <div className="flex items-center gap-3 mb-6"><div className="p-3 bg-yellow-100 rounded-full"><UserCog className="text-yellow-700" size={24} /></div><div><h2 className="text-xl font-bold text-yellow-900">ä½¿ç”¨è€…æ¬Šé™ç®¡ç†</h2><p className="text-sm text-yellow-700">ç®¡ç†èª°å¯ä»¥ä¿®æ”¹å…¨åŸŸè¨­å®š</p></div></div>
                            <div className="flex gap-2 mb-6"><input value={newAdminEmail} onChange={(e) => setNewAdminEmail(e.target.value)} placeholder="è¼¸å…¥ä½¿ç”¨è€… Email" className="flex-1 p-2 border border-yellow-300 rounded-lg text-sm bg-white" onKeyDown={(e) => e.key === 'Enter' && handleAddAdmin()} /><button onClick={handleAddAdmin} className="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-sm whitespace-nowrap">æ–°å¢ç®¡ç†å“¡</button></div>
                            <div className="bg-white rounded-lg border border-yellow-200 overflow-hidden"><ul className="divide-y divide-yellow-100">{rootAdmins.map(email => (<li key={email} className="px-4 py-3 flex justify-between items-center text-sm"><span className="flex items-center gap-2 font-bold text-slate-700"><ShieldCheck size={14} className="text-purple-600"/> {email}</span><span className="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">ç³»çµ±é è¨­</span></li>))}{cloudAdmins.map(email => (<li key={email} className="px-4 py-3 flex justify-between items-center text-sm"><span className="flex items-center gap-2 text-slate-700"><ShieldCheck size={14} className="text-yellow-600"/> {email}</span><button onClick={() => confirmRemoveAdmin(email)} className="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition"><Trash2 size={16} /></button></li>))}</ul></div>
                        </div>
                    )}

                    {/* Editor Management Panel */}
                    {isAdmin && (
                        <div className="bg-blue-50 p-8 rounded-xl shadow-sm border border-blue-200">
                            <div className="flex items-center gap-3 mb-6"><div className="p-3 bg-blue-100 rounded-full"><User className="text-blue-700" size={24} /></div><div><h2 className="text-xl font-bold text-blue-900">ç·¨è¼¯è€…æ¬Šé™ç®¡ç†</h2><p className="text-sm text-blue-700">å¯æª¢è¦–èˆ‡ç·¨è¼¯æ‰€æœ‰è³‡æ–™ï¼Œä½†ä¸å¯ä½¿ç”¨ AI èˆ‡ç³»çµ±è¨­å®š</p></div></div>
                            <div className="flex gap-2 mb-6"><input value={newEditorEmail} onChange={(e) => setNewEditorEmail(e.target.value)} placeholder="è¼¸å…¥ä½¿ç”¨è€… Email" className="flex-1 p-2 border border-blue-300 rounded-lg text-sm bg-white" onKeyDown={(e) => e.key === 'Enter' && handleAddEditor()} /><button onClick={handleAddEditor} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm whitespace-nowrap">æ–°å¢ç·¨è¼¯è€…</button></div>
                            <div className="bg-white rounded-lg border border-blue-200 overflow-hidden"><ul className="divide-y divide-blue-100">{cloudEditors.length === 0 ? (<li className="px-4 py-3 text-sm text-slate-400">å°šç„¡ç·¨è¼¯è€…</li>) : cloudEditors.map(email => (<li key={email} className="px-4 py-3 flex justify-between items-center text-sm"><span className="flex items-center gap-2 text-slate-700"><ShieldCheck size={14} className="text-blue-600"/> {email}</span><button onClick={() => confirmRemoveEditor(email)} className="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition"><Trash2 size={16} /></button></li>))}</ul></div>
                        </div>
                    )}

                    {/* Global Options: Meeting Categories */}
                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex items-center gap-3 mb-6"><div className={`p-3 rounded-full ${isAdmin ? 'bg-emerald-100' : 'bg-slate-100'}`}>{isAdmin ? <ShieldCheck className="text-emerald-700" size={24} /> : <Lock className="text-slate-500" size={24} />}</div><div><h2 className="text-xl font-bold text-slate-800">å…¨åŸŸä¸‹æ‹‰é¸å–® - æœƒè­°åˆ†é¡</h2></div></div>
                        {isAdmin && (<div className="flex gap-2 mb-4"><input value={newCategory} onChange={(e) => setNewCategory(e.target.value)} placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨±" className="flex-1 p-2 border border-slate-300 rounded-lg" onKeyDown={(e) => e.key === 'Enter' && handleAddItem('meetingCategories', newCategory, categories, setCategories, setNewCategory)} /><button onClick={() => handleAddItem('meetingCategories', newCategory, categories, setCategories, setNewCategory)} className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">æ–°å¢</button></div>)}
                        <div className="flex flex-wrap gap-2">{categories.map((cat, idx) => (<div key={idx} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full text-sm text-slate-700 border border-slate-200"><span>{cat}</span>{isAdmin && <button onClick={() => confirmDeleteItem('meetingCategories', cat, categories)} className="text-slate-400 hover:text-red-500"><X size={14} /></button>}</div>))}</div>
                    </div>

                    {/* Global Options: Task Sources */}
                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex items-center gap-3 mb-6"><div className={`p-3 rounded-full ${isAdmin ? 'bg-blue-100' : 'bg-slate-100'}`}>{isAdmin ? <ShieldCheck className="text-blue-700" size={24} /> : <Lock className="text-slate-500" size={24} />}</div><div><h2 className="text-xl font-bold text-slate-800">å…¨åŸŸä¸‹æ‹‰é¸å–® - å¾…è¾¦ä¾†æº</h2></div></div>
                        {isAdmin && (<div className="flex gap-2 mb-4"><input value={newTaskSource} onChange={(e) => setNewTaskSource(e.target.value)} placeholder="è¼¸å…¥æ–°ä¾†æºåç¨±" className="flex-1 p-2 border border-slate-300 rounded-lg" onKeyDown={(e) => e.key === 'Enter' && handleAddItem('taskSources', newTaskSource, taskSources, setTaskSources, setNewTaskSource)} /><button onClick={() => handleAddItem('taskSources', newTaskSource, taskSources, setTaskSources, setNewTaskSource)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">æ–°å¢</button></div>)}
                        <div className="flex flex-wrap gap-2">{taskSources.map((src, idx) => (<div key={idx} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full text-sm text-slate-700 border border-slate-200"><span>{src}</span>{isAdmin && <button onClick={() => confirmDeleteItem('taskSources', src, taskSources)} className="text-slate-400 hover:text-red-500"><X size={14} /></button>}</div>))}</div>
                    </div>

                    {/* Global Options: Task Statuses */}
                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex items-center gap-3 mb-6"><div className={`p-3 rounded-full ${isAdmin ? 'bg-indigo-100' : 'bg-slate-100'}`}>{isAdmin ? <ShieldCheck className="text-indigo-700" size={24} /> : <Lock className="text-slate-500" size={24} />}</div><div><h2 className="text-xl font-bold text-slate-800">å…¨åŸŸä¸‹æ‹‰é¸å–® - å¾…è¾¦ç‹€æ…‹</h2></div></div>
                        {isAdmin && (<div className="flex gap-2 mb-4"><input value={newTaskStatus} onChange={(e) => setNewTaskStatus(e.target.value)} placeholder="è¼¸å…¥æ–°ç‹€æ…‹åç¨±" className="flex-1 p-2 border border-slate-300 rounded-lg" onKeyDown={(e) => e.key === 'Enter' && handleAddItem('taskStatuses', newTaskStatus, taskStatuses, setTaskStatuses, setNewTaskStatus)} /><button onClick={() => handleAddItem('taskStatuses', newTaskStatus, taskStatuses, setTaskStatuses, setNewTaskStatus)} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">æ–°å¢</button></div>)}
                        <div className="flex flex-wrap gap-2">{taskStatuses.map((st, idx) => (<div key={idx} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-full text-sm text-slate-700 border border-slate-200"><span>{st}</span>{isAdmin && <button onClick={() => confirmDeleteItem('taskStatuses', st, taskStatuses)} className="text-slate-400 hover:text-red-500"><X size={14} /></button>}</div>))}</div>
                    </div>
                </div>
            );
        };

        // --- 4. Main App Component (Must be last) ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('tasks'); 
            const [appInstance, setAppInstance] = useState(null);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [user, setUser] = useState(null);
            const [error, setError] = useState(null);
            const [statusMsg, setStatusMsg] = useState('åˆå§‹åŒ–ä¸­...');
            const [isAuthChecking, setIsAuthChecking] = useState(true);
            const [cloudAdmins, setCloudAdmins] = useState([]);
            const [cloudEditors, setCloudEditors] = useState([]);
            
            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        const APP_NAME = 'work-tracker-app';
                        let app;
                        const existingApp = getApps().find(app => app.name === APP_NAME);
                        if (existingApp) {
                            app = existingApp;
                        } else {
                            app = initializeApp(DEFAULT_CONFIG, APP_NAME);
                        }
                        const authInstance = getAuth(app);
                        const dbInstance = getFirestore(app);
                        setAppInstance(app);
                        setAuth(authInstance);
                        setDb(dbInstance);
                        onAuthStateChanged(authInstance, (u) => {
                            setUser(u);
                            setIsAuthChecking(false);
                            setStatusMsg(u ? 'å·²é€£ç·š' : 'è«‹å…ˆç™»å…¥');
                        });
                    } catch (err) {
                        console.error("Firebase Init Error:", err);
                        setError(`é€£ç·šéŒ¯èª¤: ${err.message}`);
                        setIsAuthChecking(false);
                    }
                };
                initFirebase();
            }, []);

            useEffect(() => {
                if (!db) return;
                const adminsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'admins');
                const unsubscribe = onSnapshot(adminsRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().list) {
                        setCloudAdmins(docSnap.data().list);
                    } else {
                        setCloudAdmins([]);
                    }
                });
                return () => unsubscribe();
            }, [db]);

            useEffect(() => {
                if (!db) return;
                const editorsRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'settings', 'editors');
                const unsubscribe = onSnapshot(editorsRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().list) {
                        setCloudEditors(docSnap.data().list);
                    } else {
                        setCloudEditors([]);
                    }
                });
                return () => unsubscribe();
            }, [db]);

            useEffect(() => {
                if (!db || !user || !user.uid) return;
                const registerUser = async () => {
                    try {
                        const userRef = doc(db, 'artifacts', 'work-tracker-v1', 'public', 'data', 'users', user.uid);
                        const snapshot = await getDoc(userRef);
                        const existingData = snapshot.exists() ? snapshot.data() : {};
                        const resolvedEmail = user.email || existingData.email;
                        const payload = {
                            uid: user.uid,
                            lastSeen: serverTimestamp(),
                            lastLoginAt: serverTimestamp()
                        };
                        if (resolvedEmail) {
                            payload.email = resolvedEmail;
                        }
                        if (!existingData.createdAt) {
                            payload.createdAt = serverTimestamp();
                        }
                        await setDoc(userRef, payload, { merge: true });
                    } catch (e) {
                        console.error("User Registry Error:", e);
                    }
                };
                registerUser();
            }, [db, user]);

            const isUserAdmin = useMemo(() => checkIsAdmin(user, cloudAdmins), [user, cloudAdmins]);
            const isUserEditor = useMemo(() => checkIsEditor(user, cloudEditors), [user, cloudEditors]);
            const isUserPrivileged = isUserAdmin || isUserEditor;

            const handleSaveGeminiKey = (key) => {
                alert("API Key å·²å…§å»ºï¼Œç„¡éœ€è¨­å®šï¼");
            };

            if (isAuthChecking) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 text-slate-500">
                        <Loader2 size={48} className="animate-spin mb-4 text-blue-600" />
                        <p>æ­£åœ¨é€£ç·šè‡³ç³»çµ±...</p>
                    </div>
                );
            }

            if (!user) {
                return <AuthPage auth={auth} error={error} />;
            }

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-slate-800 flex flex-col md:flex-row">
                    <aside className="w-full md:w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col shadow-xl z-10">
                        <div className="p-6 border-b border-slate-700">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Database className="text-blue-400" />
                                å·¥ä½œç´€éŒ„ä¸­å¿ƒ
                            </h1>
                            <p className="text-xs text-slate-400 mt-2">Firebase é›²ç«¯åŒæ­¥ç‰ˆ</p>
                        </div>
                        <nav className="p-4 space-y-2 flex-1">
                            <NavButton active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} icon={<LayoutDashboard size={20} />} label="æ•¸æ“šçœ‹æ¿" />
                            <NavButton active={activeTab === 'tasks'} onClick={() => setActiveTab('tasks')} icon={<CheckCircle2 size={20} />} label="å¾…è¾¦äº‹é …" />
                            <NavButton active={activeTab === 'meetings'} onClick={() => setActiveTab('meetings')} icon={<Users size={20} />} label="æœƒè­°è¨˜éŒ„" />
                            
                            {isUserAdmin && (
                                <div className="pt-4 border-t border-slate-700 mt-4">
                                    <NavButton active={activeTab === 'settings'} onClick={() => setActiveTab('settings')} icon={<Settings size={20} />} label="ç³»çµ±è¨­å®š" />
                                </div>
                            )}
                        </nav>
                        <div className="p-4 bg-slate-800 border-t border-slate-700">
                            <div className="flex items-center gap-2 mb-4">
                                <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold">
                                    {user.email ? user.email.charAt(0).toUpperCase() : 'U'}
                                </div>
                                <div className="overflow-hidden">
                                    <div className="text-sm font-bold truncate w-32">{user.email}</div>
                                    <div className="text-[10px] text-slate-400 flex items-center gap-1">
                                        {isUserAdmin ? (
                                            <span className="text-yellow-400 flex items-center gap-0.5"><ShieldCheck size={10}/> Admin</span>
                                        ) : isUserEditor ? (
                                            <span className="text-blue-400 flex items-center gap-0.5"><ShieldCheck size={10}/> Editor</span>
                                        ) : (
                                            'User'
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            <button onClick={() => signOut(auth)} className="w-full text-xs flex items-center justify-center gap-2 py-2 bg-slate-700 hover:bg-slate-600 rounded text-slate-300 transition mb-3">
                                <LogOut size={14} /> ç™»å‡º
                            </button>

                            <div className="pt-3 border-t border-slate-700 text-[10px] text-slate-500 text-center">
                                <p>System Creator: {SYSTEM_CREATOR}</p>
                                <p>Version: {APP_VERSION}</p>
                            </div>
                        </div>
                    </aside>
                    
                    <main className="flex-1 overflow-y-auto h-screen p-4 md:p-8 relative bg-slate-50/50">
                        {activeTab === 'dashboard' && <Dashboard db={db} user={user} canAccessAll={isUserPrivileged} isAdmin={isUserAdmin} />}
                        {activeTab === 'tasks' && <TaskManager db={db} user={user} canAccessAll={isUserPrivileged} isAdmin={isUserAdmin} />}
                        {activeTab === 'meetings' && <MeetingMinutes db={db} user={user} canAccessAll={isUserPrivileged} isAdmin={isUserAdmin} isRootAdmin={isUserAdmin} />}
                        {activeTab === 'settings' && (
                            isUserAdmin ? (
                                <SettingsPage db={db} user={user} isAdmin={isUserAdmin} cloudAdmins={cloudAdmins} cloudEditors={cloudEditors} rootAdmins={ROOT_ADMINS} onSaveGeminiKey={handleSaveGeminiKey} />
                            ) : (
                                <div className="flex flex-col items-center justify-center h-full text-slate-400">
                                    <ShieldAlert size={48} className="mb-4" />
                                    <h2 className="text-xl font-bold text-slate-600">æ¬Šé™ä¸è¶³</h2>
                                    <p>æ‚¨æ²’æœ‰æ¬Šé™å­˜å–ç³»çµ±è¨­å®šé é¢ã€‚</p>
                                </div>
                            )
                        )}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>





